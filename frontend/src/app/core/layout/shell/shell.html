<div class="flex min-h-screen flex-col bg-surface">
  <header class="shell-header">
    @if (profileToastMessage(); as toast) {
      <div class="shell-toast" role="status" aria-live="polite">
        <svg
          aria-hidden="true"
          viewBox="0 0 24 24"
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          stroke-width="1.8"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 12.5 10 17l9-10" />
        </svg>
        <span>{{ toast }}</span>
      </div>
    }
    <div class="shell-header__content shell-container">
      <div class="shell-header__surface">
        <div class="shell-header__grid">
          <div class="shell-brand">
            <span class="shell-brand__mark">VY</span>
            <div class="shell-brand__info">
              <p class="shell-brand__name">Verbalize Yourself</p>
              <p class="shell-brand__tagline">AIガイドのリフレクションワークスペース</p>
            </div>
          </div>

          <div class="shell-nav-wrapper">
            <nav class="shell-nav" aria-label="主要ナビゲーション">
              @for (link of navigationLinks(); track link.path) {
                <a
                  [routerLink]="link.path"
                  routerLinkActive="shell-nav__link--active"
                  [routerLinkActiveOptions]="{ exact: true }"
                  class="shell-nav__link focus-ring"
                >
                  {{ link.label }}
                </a>
              }
            </nav>
          </div>

          <div class="shell-actions">
            <div class="shell-actions__controls">
              <button
                type="button"
                class="shell-help-button focus-ring"
                (click)="openHelp()"
                aria-haspopup="dialog"
                [attr.aria-expanded]="isHelpDialogOpen()"
                [attr.aria-controls]="isHelpDialogOpen() ? 'help-dialog' : null"
                aria-label="Verbalize Yourself の使い方を開く"
              >
                <svg
                  aria-hidden="true"
                  viewBox="0 0 24 24"
                  class="h-4 w-4"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 18h.01M9.09 9a3 3 0 0 1 5.83 1.11c0 2-3 3-3 3"
                  />
                  <circle cx="12" cy="12" r="9" />
                </svg>
              </button>

              <button
                type="button"
                class="shell-quick-action focus-ring"
                (click)="toggleTheme()"
                [attr.aria-label]="themeToggleAriaLabel()"
              >
                <span class="shell-quick-action__icon">
                  @if (themePreference() === 'system') {
                    <svg
                      aria-hidden="true"
                      viewBox="0 0 24 24"
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                    >
                      <rect x="3" y="4" width="18" height="13" rx="2" />
                      <path stroke-linecap="round" d="M8 21h8m-4-4v4" />
                    </svg>
                  } @else if (isDark()) {
                    <svg
                      aria-hidden="true"
                      viewBox="0 0 24 24"
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M21 12.79A9 9 0 0 1 11.21 3 7 7 0 1 0 21 12.79Z"
                      />
                    </svg>
                  } @else {
                    <svg
                      aria-hidden="true"
                      viewBox="0 0 24 24"
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                    >
                      <circle cx="12" cy="12" r="4" />
                      <path
                        stroke-linecap="round"
                        d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-6.364-1.414 1.414M7.05 16.95l-1.414 1.414m0-12.728 1.414 1.414m10.9 10.9 1.414 1.414"
                      />
                    </svg>
                  }
                </span>
              </button>

              @if (user()) {
                <button
                  type="button"
                  class="shell-icon-action focus-ring"
                  (click)="logout()"
                  aria-label="ログアウト"
                  title="ログアウト"
                >
                  <span class="shell-icon-action__icon">
                    <svg
                      aria-hidden="true"
                      viewBox="0 0 24 24"
                      class="h-4 w-4"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.8"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6A2.25 2.25 0 0 0 5.25 5.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15"
                      />
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 9l3 3m0 0-3 3m3-3H3"
                      />
                    </svg>
                  </span>
                </button>
              }
            </div>

            @if (user(); as currentUser) {
              <button
                type="button"
                class="shell-user focus-ring"
                (click)="openProfile()"
                aria-haspopup="dialog"
                [attr.aria-expanded]="isProfileDialogOpen()"
                aria-label="プロフィール設定を開く"
              >
                <span class="shell-user__avatar" aria-hidden="true">
                  @if (currentUser.avatar_url; as avatarUrl) {
                    <img [src]="avatarUrl" alt="" />
                  } @else {
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm-7 9a7 7 0 0 1 14 0"
                      />
                    </svg>
                  }
                </span>
                <span class="shell-user__details">
                  <span class="shell-user__name">{{
                    currentUser.nickname ?? currentUser.email
                  }}</span>
                  <span class="shell-user__meta">
                    @if (currentUser.roles.length) {
                      <span
                        class="shell-user__roles"
                        [attr.title]="currentUser.roles.join(' / ')"
                      >
                        {{ formatRolePreview(currentUser.roles) }}
                      </span>
                    }
                    <span class="shell-user__email">{{ currentUser.email }}</span>
                  </span>
                </span>
              </button>
            }
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="shell-container flex flex-1 flex-col gap-6 px-0 py-0">
    <section class="flex-1">
      <router-outlet />
    </section>
  </main>

  <footer class="border-t border-subtle bg-surface-strong">
    <div
      class="shell-container flex flex-col gap-2 px-0 py-0 text-xs text-slate-500 dark:text-slate-400 sm:flex-row sm:items-center sm:justify-between"
    >
      <p>© {{ year }} Verbalize Yourself</p>
      <p>Angular 20 Signal Architecture / ChatGPT モック統合</p>
    </div>
  </footer>

  @if (isProfileDialogOpen()) {
    <app-profile-dialog (dismiss)="closeProfile()" (profileSaved)="onProfileSaved($event)" />
  }

  @if (isHelpDialogOpen()) {
    <app-help-dialog (dismiss)="closeHelp()" />
  }
</div>
