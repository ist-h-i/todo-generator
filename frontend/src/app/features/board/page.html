<section class="grid min-h-full gap-10 lg:grid-rows-[auto_1fr]">
  <div class="grid gap-6 lg:grid-cols-[minmax(0,280px)_minmax(0,1fr)]">
    @if (summarySignal(); as summary) {
      <section class="surface-panel flex flex-col gap-6 px-6 py-8">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">進捗状況</p>
          <p class="mt-2 text-xl font-semibold text-on-surface">
            {{ summary.progressRatio }}% 完了
          </p>
        </div>
        <div class="space-y-3">
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>完了カード</span>
            <span class="font-semibold text-on-surface">{{ summary.doneCards }}</span>
          </div>
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>総カード数</span>
            <span class="font-semibold text-on-surface">{{ summary.totalCards }}</span>
          </div>
          <div class="flex items-center justify-between text-sm text-slate-500">
            <span>アクティブラベル</span>
            <span class="font-semibold text-on-surface">{{ summary.activeLabels }}</span>
          </div>
        </div>
        <div class="h-2 w-full rounded-full bg-slate-200 dark:bg-slate-800">
          <div
            class="h-2 rounded-full bg-accent transition-all"
            [style.width.%]="summary.progressRatio"
          ></div>
        </div>
      </section>
    }
    <div class="flex h-full min-w-0 flex-col gap-4">
      <header class="space-y-3">
        <div class="flex min-w-0 flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div class="min-w-0">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Workspace Board</p>
            <h2 class="text-2xl font-semibold text-on-surface">カード管理ボード</h2>
          </div>
          <div class="flex flex-wrap gap-2 text-xs text-slate-500">
            <span class="surface-pill px-3 py-1">{{ filtersSignal().search || '検索なし' }}</span>
            <span class="surface-pill px-3 py-1">タスク: {{ groupingLabelSignal() }}</span>
            <span class="surface-pill px-3 py-1">サブタスク: ステータス別</span>
            <span class="surface-pill px-3 py-1">クイック: {{ quickFilterSummarySignal() }}</span>
          </div>
        </div>
      </header>
      <section
        class="board-toolbar rounded-3xl border border-subtle bg-surface px-6 py-6 shadow-soft"
      >
        <div class="board-toolbar__grid">
          <label
            class="board-toolbar__search text-sm text-slate-600 dark:text-slate-300"
          >
            <span
              class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500"
              >検索</span
            >
            <div class="board-toolbar__search-field">
              <svg
                class="board-toolbar__search-icon"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  d="m21 21-4.35-4.35M18 10.5a7.5 7.5 0 1 1-15 0 7.5 7.5 0 0 1 15 0Z"
                  fill="none"
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="1.5"
                />
              </svg>
              <input
                type="search"
                class="board-toolbar__search-control"
                placeholder="キーワードでカードを検索"
                [value]="searchForm.controls.search.value()"
                (input)="updateSearch($any($event.target).value)"
              />
            </div>
          </label>
          <div class="board-toolbar__actions text-xs text-slate-500">
            <div class="board-toolbar__view">
              <span
                class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500"
                >ビュー</span
              >
              <div class="board-toolbar__view-buttons">
                <button
                  type="button"
                  class="surface-pill focus-ring px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500"
                  [class.surface-primary-muted]="groupingSignal() === 'status'"
                  (click)="selectGrouping('status')"
                >
                  ステータス別
                </button>
                <button
                  type="button"
                  class="surface-pill focus-ring px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500"
                  [class.surface-primary-muted]="groupingSignal() === 'label'"
                  (click)="selectGrouping('label')"
                >
                  ラベル別
                </button>
              </div>
            </div>
            <button
              type="button"
              class="board-toolbar__clear surface-pill focus-ring px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-500"
              (click)="clearFilters()"
            >
              フィルターをクリア
            </button>
          </div>
        </div>
        <div class="board-toolbar__quick text-xs text-slate-500">
          <span
            class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500"
            >クイック</span
          >
          <div class="board-toolbar__quick-actions">
            @for (filter of quickFilters; track filter.id) {
              <button
                type="button"
                class="surface-pill focus-ring px-3 py-1 text-xs font-semibold text-slate-500"
                [class.surface-primary-muted]="isQuickFilterActive(filter.id)"
                [attr.aria-pressed]="isQuickFilterActive(filter.id)"
                [title]="filter.description"
                (click)="toggleQuickFilter(filter.id)"
              >
                {{ filter.label }}
              </button>
            }
          </div>
        </div>
      </section>
      <p class="rounded-3xl bg-accent-muted px-6 py-4 text-sm text-accent-strong shadow-soft">
        タスクはラベルやステータスで切り替えながら管理でき、サブタスクはステータス別ボードでドラッグ＆ドロップ更新できます。選択したタスクに紐づくサブタスクはハイライト表示されます。
      </p>
    </div>
  </div>

  <div class="flex min-h-0 flex-col gap-8">
    <section class="space-y-4">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <h3 class="text-lg font-semibold text-on-surface">タスク一覧</h3>
        <span class="text-xs text-slate-500"
          >完了またはNonIssueのサブタスクのみのタスクは簡易表示になります。</span
        >
      </div>
      <div class="board-columns" cdkDropListGroup>
        @for (column of columnsSignal(); track column.id) {
          <section
            class="board-column"
            cdkDropList
            [cdkDropListData]="column.cards"
            [cdkDropListDisabled]="groupingSignal() !== 'status'"
            (cdkDropListDropped)="handleDrop(column.id, $event)"
          >
            <header class="flex items-center justify-between">
              <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">{{ column.id }}</p>
                <h3 class="text-lg font-semibold" [style.color]="columnAccent(column)">
                  {{ column.title }}
                </h3>
              </div>
              <span class="surface-pill px-3 py-1 text-xs font-semibold text-slate-500"
                >{{ column.count }} 件</span
              >
            </header>
            <div class="board-card-list">
              @if (column.cards.length === 0) {
                <p class="board-empty text-sm">
                  カードがありません。{{
                    groupingSignal() === 'status'
                      ? 'ここにカードをドラッグすると移動できます。'
                      : ''
                  }}
                </p>
              } @else {
                @for (cardId of column.cards; track cardId) {
                  @if (cardsByIdSignal().get(cardId); as card) {
                    <article
                      class="board-card surface-card flex min-w-0 flex-col gap-4 px-5 py-5"
                      cdkDrag
                      [cdkDragData]="card.id"
                      [cdkDragDisabled]="groupingSignal() !== 'status'"
                      [style.borderColor]="statusColor(card.statusId) + '55'"
                      [style.background]="
                        'linear-gradient(180deg, ' +
                        statusColor(card.statusId) +
                        '18 0%, var(--surface-card) 55%, var(--surface-card-muted) 100%)'
                      "
                      [class.board-card--compact]="isCardResolved(card)"
                      [class.board-card--active]="isActiveCard(card.id)"
                    >
                      <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0 space-y-2">
                          <h4 class="break-words text-base font-semibold text-on-surface">
                            {{ card.title }}
                          </h4>
                          @if (!isCardResolved(card)) {
                            <p
                              class="break-words text-sm leading-6 text-slate-600 dark:text-slate-300"
                            >
                              {{ card.summary }}
                            </p>
                          } @else {
                            <p class="board-card-compact-note text-xs text-slate-500">
                              サブタスクはすべて完了または NonIssue です。
                            </p>
                          }
                        </div>
                        <button
                          type="button"
                          class="surface-pill focus-ring px-3 py-1 text-xs font-semibold text-slate-500"
                          (click)="openCard(card.id)"
                        >
                          詳細
                        </button>
                      </div>
                      <div class="flex flex-wrap gap-2 text-xs font-medium text-slate-500">
                        <span class="board-badge" [style.color]="statusColor(card.statusId)">
                          {{ statusName(card.statusId) }}
                        </span>
                        @for (labelId of card.labelIds; track labelId) {
                          <span class="board-badge">{{ labelName(labelId) }}</span>
                        }
                      </div>
                      @if (!isCardResolved(card)) {
                        <div class="flex flex-wrap items-center gap-3 text-xs text-slate-500">
                          <span>SP: {{ card.storyPoints }}</span>
                          @if (card.assignee) {
                            <span>担当: {{ card.assignee }}</span>
                          }
                          @if (card.confidence) {
                            <span
                              >AIおすすめ度: {{ card.confidence * 100 | number: '1.0-0' }}%</span
                            >
                          }
                        </div>
                        @if (groupingSignal() !== 'status') {
                          <div class="flex flex-wrap gap-2 text-xs">
                            @for (status of statusesSignal(); track status.id) {
                              <button
                                type="button"
                                class="surface-pill focus-ring px-3 py-1"
                                (click)="moveCard(card.id, status.id)"
                              >
                                {{ status.name }}
                              </button>
                            }
                          </div>
                        }
                      }
                    </article>
                  }
                }
              }
            </div>
          </section>
        }
      </div>
    </section>

    <section class="space-y-4">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h3 class="text-lg font-semibold text-on-surface">サブタスク一覧</h3>
          <p class="text-xs text-slate-500">ステータスごとに並び替え、個別に管理します。</p>
        </div>
        <div
          class="rounded-3xl border border-subtle bg-surface px-4 py-2 text-xs text-slate-500 shadow-soft"
        >
          ドラッグ＆ドロップでステータスを更新できます。
        </div>
      </div>
      <div class="board-columns subtask-columns" cdkDropListGroup>
        @for (column of subtaskColumnsSignal(); track column.id) {
          <section
            class="board-column subtask-column"
            cdkDropList
            [cdkDropListData]="column.subtasks"
            (cdkDropListDropped)="handleSubtaskDrop(column.id, $event)"
          >
            <header class="flex items-center justify-between">
              <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">{{ column.id }}</p>
                <h3 class="text-lg font-semibold" [style.color]="column.accent">
                  {{ column.title }}
                </h3>
              </div>
              <span class="surface-pill px-3 py-1 text-xs font-semibold text-slate-500">
                {{ column.subtasks.length }} 件
              </span>
            </header>
            <div class="board-card-list">
              @if (column.subtasks.length === 0) {
                <p class="board-empty text-sm">このステータスのサブタスクはありません。</p>
              } @else {
                @for (subtask of column.subtasks; track subtask.id) {
                  <article
                    class="board-card subtask-card surface-card flex min-w-0 flex-col gap-3 px-4 py-4"
                    cdkDrag
                    [cdkDragData]="subtask"
                    [style.borderColor]="column.accent + '55'"
                    [style.background]="
                      'linear-gradient(180deg, ' +
                      column.accent +
                      '18 0%, var(--surface-card) 55%, var(--surface-card-muted) 100%)'
                    "
                    [class.subtask-card--highlight]="subtask.highlight"
                    [class.subtask-card--compact]="subtask.isCompact"
                  >
                    <div class="flex items-start justify-between gap-2">
                      <h4 class="min-w-0 break-words text-sm font-semibold text-on-surface">
                        {{ subtask.title }}
                      </h4>
                      <span
                        class="text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-500"
                      >
                        {{ column.title }}
                      </span>
                    </div>
                    <p class="text-xs text-slate-500">
                      親タスク:
                      <span class="break-words font-medium text-on-surface">{{
                        subtask.parentTitle
                      }}</span>
                    </p>
                    <div
                      class="subtask-card-labels flex flex-wrap gap-2 text-[11px] text-slate-500"
                    >
                      @for (labelId of subtask.parentLabels; track labelId) {
                        <span class="subtask-badge">{{ labelName(labelId) }}</span>
                      }
                    </div>
                    @if (!subtask.isCompact) {
                      <div class="flex flex-wrap items-center gap-3 text-[11px] text-slate-500">
                        @if (subtask.assignee) {
                          <span>担当: {{ subtask.assignee }}</span>
                        }
                        @if (subtask.estimateHours) {
                          <span>工数: {{ subtask.estimateHours }}h</span>
                        }
                      </div>
                    } @else {
                      <p class="subtask-card-compact-note text-xs text-slate-500">
                        {{
                          subtask.status === 'non-issue'
                            ? 'NonIssue として対応済み'
                            : '完了済みのサブタスク'
                        }}
                      </p>
                    }
                  </article>
                }
              }
            </div>
          </section>
        }
      </div>
    </section>

    @if (selectedCardSignal(); as active) {
      <aside class="surface-panel grid min-w-0 gap-6 px-8 py-8 lg:grid-cols-[2fr_1fr]">
        <div class="min-w-0 space-y-4">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-semibold text-on-surface">{{ active.title }}</h3>
            <button
              type="button"
              class="surface-pill focus-ring px-4 py-2 text-xs font-semibold"
              (click)="openCard(null)"
            >
              閉じる
            </button>
          </div>
          <p class="break-words text-sm leading-6 text-slate-600 dark:text-slate-300">
            {{ active.summary }}
          </p>
          <div class="space-y-2">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">サブタスク</p>
            <ul class="space-y-2 text-sm text-slate-600 dark:text-slate-300">
              @for (task of active.subtasks; track task.id) {
                <li
                  class="flex items-center justify-between rounded-2xl border border-subtle bg-surface px-4 py-3"
                >
                  <span class="break-words">{{ task.title }}</span>
                  <span class="text-xs text-slate-500">{{ task.status }}</span>
                </li>
              }
            </ul>
          </div>
        </div>
        <div class="min-w-0 space-y-4">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">コメント</p>
          <form
            class="grid gap-3 rounded-2xl border border-dashed border-subtle bg-surface px-5 py-5"
            (submit)="saveComment($event)"
          >
            <div class="grid gap-2">
              <label
                class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500"
                for="comment-author"
                >担当者</label
              >
              <input
                type="text"
                id="comment-author"
                class="rounded-2xl border border-subtle bg-surface px-4 py-3 text-sm focus-ring"
                placeholder="例: 田中太郎"
                [value]="commentForm.controls.author.value()"
                (input)="commentForm.controls.author.setValue($any($event.target).value)"
              />
            </div>
            <div class="grid gap-2">
              <label
                class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500"
                for="comment-message"
                >コメント</label
              >
              <textarea
                id="comment-message"
                class="min-h-[80px] rounded-2xl border border-subtle bg-surface px-4 py-3 text-sm focus-ring"
                placeholder="進捗やメモを追加しましょう"
                [value]="commentForm.controls.message.value()"
                (input)="commentForm.controls.message.setValue($any($event.target).value)"
              ></textarea>
            </div>
            <button
              type="submit"
              class="surface-primary focus-ring rounded-full px-5 py-3 text-sm font-semibold disabled:pointer-events-none disabled:opacity-60"
              [disabled]="!isCommentFormValid()"
            >
              コメントを追加
            </button>
          </form>
          @if (active.comments.length === 0) {
            <p
              class="rounded-2xl border border-dashed border-subtle px-4 py-6 text-sm text-slate-500"
            >
              コメントはまだありません。
            </p>
          } @else {
            <ul class="space-y-3 text-sm text-slate-600 dark:text-slate-300">
              @for (comment of active.comments; track comment.id) {
                <li class="space-y-2 rounded-2xl border border-subtle bg-surface px-4 py-3">
                  <div
                    class="flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500"
                  >
                    <span class="text-sm font-semibold text-on-surface">
                      担当: {{ comment.author }}
                    </span>
                    <span>更新: {{ comment.updatedAt | date: 'yyyy/MM/dd HH:mm' }}</span>
                  </div>
                  <p class="break-words">{{ comment.message }}</p>
                </li>
              }
            </ul>
          }
        </div>
      </aside>
    }
  </div>
</section>
