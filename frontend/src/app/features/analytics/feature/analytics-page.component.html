<app-page-layout
  class="analytics-page"
  eyebrow="分析ダッシュボード"
  title="ワークスペース全体の状況"
  description="進捗・ステータス・ラベルの内訳をまとめて確認できます。"
  headingLevel="h1"
>
  <section class="page-section analytics-page__intro">
    <div class="analytics-page__intro-content">
      <p>日々のタスク実行状況を俯瞰して、次の一手を決めやすくします。</p>
    </div>
    <div class="analytics-page__intro-actions">
      <a routerLink="/profile/evaluations" class="button button--secondary button--pill">
        最新の評価を確認
        <svg
          aria-hidden="true"
          viewBox="0 0 24 24"
          class="analytics-page__intro-icon"
          fill="none"
          stroke="currentColor"
          stroke-width="1.8"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>
  </section>

  @if (summarySignal(); as summary) {
    <section class="page-section analytics-summary">
      <ul class="page-list analytics-summary__metrics">
        <li class="page-list__item analytics-summary__metric">
          <p class="analytics-summary__eyebrow">進捗率</p>
          <p class="analytics-summary__value">{{ summary.progressRatio }}%</p>
          <p class="analytics-summary__note">完了カード {{ summary.doneCards }}/{{ summary.totalCards }}</p>
        </li>
        <li class="page-list__item analytics-summary__metric">
          <p class="analytics-summary__eyebrow">カード総数</p>
          <p class="analytics-summary__value">{{ summary.totalCards }}</p>
          <p class="analytics-summary__note">利用中のラベル {{ summary.activeLabels }}</p>
        </li>
        <li class="page-list__item analytics-summary__metric">
          <p class="analytics-summary__eyebrow">完了ポイント</p>
          <p class="analytics-summary__value">{{ pointSummary().done }}</p>
          <p class="analytics-summary__note">残り {{ pointSummary().remaining }}</p>
        </li>
        <li class="page-list__item analytics-summary__metric">
          <p class="analytics-summary__eyebrow">総ポイント</p>
          <p class="analytics-summary__value">{{ pointSummary().total }}</p>
          <p class="analytics-summary__note">負荷の目安として活用できます</p>
        </li>
      </ul>
    </section>
  }

  <div class="grid gap-4 lg:grid-cols-2">
    <section class="page-section analytics-breakdown">
      <header class="page-section__header">
        <h3 class="page-section__title">ステータス別の件数</h3>
        <span class="page-section__subtitle">{{ statusBreakdown().length }} ステージ</span>
      </header>
      <ul class="page-list analytics-breakdown__list">
        @for (item of statusBreakdown(); track item.id) {
          <li class="page-list__item analytics-breakdown__item">
            <span class="analytics-breakdown__swatch" [style.backgroundColor]="item.color"></span>
            <span class="analytics-breakdown__label">{{ item.name }}</span>
            <span class="analytics-breakdown__value">{{ item.total }}</span>
          </li>
        }
      </ul>
    </section>

    <section class="page-section analytics-breakdown">
      <header class="page-section__header">
        <h3 class="page-section__title">ラベル別の件数</h3>
        <span class="page-section__subtitle">{{ labelBreakdown().length }} ラベル</span>
      </header>
      <ul class="page-list analytics-breakdown__list">
        @for (item of labelBreakdown(); track item.id) {
          <li class="page-list__item analytics-breakdown__item">
            <span class="analytics-breakdown__swatch" [style.backgroundColor]="item.color"></span>
            <span class="analytics-breakdown__label">{{ item.name }}</span>
            <span class="analytics-breakdown__value">{{ item.total }}</span>
          </li>
        }
      </ul>
    </section>
  </div>

  <section class="page-section analytics-immunity-map">
    <header class="page-section__header">
      <div>
        <h3 class="page-section__title">免疫マップ生成</h3>
        <p class="page-section__subtitle">
          日報週報・カード履歴から A 候補を作成し、選択内容で免疫マップを生成します。
        </p>
      </div>
      <div class="page-section__actions">
        <button
          type="button"
          class="button button--secondary button--pill"
          (click)="refreshCandidates()"
          [disabled]="candidatesLoading()"
          [attr.aria-busy]="candidatesLoading()"
        >
          候補を更新
        </button>
      </div>
    </header>

    <div class="grid gap-4 lg:grid-cols-[minmax(0,7fr)_minmax(0,5fr)]">
      <section class="surface-panel page-panel analytics-immunity-map__composer">
        <div class="flex flex-col gap-4">
          <div class="form-grid form-grid--two">
            <label class="form-field">
              <span class="form-field__label">参照期間</span>
              <select
                class="form-control app-select"
                [value]="windowDays()"
                (change)="updateWindowDays($any($event.target).value)"
              >
                <option value="7">直近 7 日</option>
                <option value="14">直近 14 日</option>
                <option value="28">直近 28 日</option>
                <option value="56">直近 56 日</option>
                <option value="84">直近 84 日</option>
              </select>
              <p class="form-note">日報週報・カード履歴をもとに候補を作成します。</p>
            </label>
            <div class="form-field">
              <span class="form-field__label">選択中の候補</span>
              <p class="page-badge page-badge--accent">{{ selectedCandidateCount() }} 件</p>
              <p class="form-note">候補は複数選択できます。</p>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-2">
            <button
              type="button"
              class="button button--ghost button--pill"
              (click)="toggleAdvancedMode()"
              [attr.aria-pressed]="advancedMode()"
            >
              上級モード
            </button>
            @if (candidateSourcesLabel()) {
              <span class="page-badge">{{ candidateSourcesLabel() }}</span>
            }
          </div>

          @if (candidateContextSummary()) {
            <div class="surface-card flex flex-col gap-2">
              <p class="form-field__label">AI が参照したサマリー</p>
              <p>{{ candidateContextSummary() }}</p>
            </div>
          }

          <div class="flex items-center justify-between">
            <h4 class="page-section__title">A 候補カード</h4>
            <span class="page-section__subtitle">候補を選択・編集して生成します。</span>
          </div>

          @if (candidatesLoading()) {
            <div class="page-state" role="status" aria-live="polite">
              <h2>候補を生成しています</h2>
              <p>AI が候補カードを準備しています...</p>
            </div>
          } @else if (candidatesError()) {
            <p class="app-alert app-alert--error" role="alert">
              候補カードの取得に失敗しました。時間をおいて再度お試しください。
            </p>
          } @else if (candidates().length === 0) {
            <div class="page-state">
              <h2>候補カードがありません</h2>
              <p>参照データが足りない場合は上級モードで手入力できます。</p>
            </div>
          } @else {
            <div class="flex flex-col gap-4">
              @for (candidate of candidates(); track candidate.id; let index = $index) {
                @let isSelected = selectedCandidateIds().includes(candidate.id);
                <article
                  class="surface-card flex flex-col gap-4"
                  [attr.data-selected]="isSelected"
                >
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <div class="flex flex-wrap items-center gap-2">
                      <span class="page-badge page-badge--accent">候補 {{ index + 1 }}</span>
                      <span class="page-badge">{{ formatKindLabel(candidate.a_item.kind) }}</span>
                      @if (candidate.confidence != null) {
                        <span class="page-badge">
                          信頼度 {{ candidate.confidence | number: '1.0-0' }}%
                        </span>
                      }
                    </div>
                    <button
                      type="button"
                      class="button button--pill"
                      [class.button--ghost]="!isSelected"
                      [attr.aria-pressed]="isSelected"
                      (click)="toggleCandidateSelection(candidate.id)"
                    >
                      {{ isSelected ? '選択中' : '候補を選択' }}
                    </button>
                  </div>

                  <label class="form-field">
                    <span class="form-field__label">A の文言</span>
                    <input
                      type="text"
                      class="form-control"
                      [value]="candidateText(candidate)"
                      (input)="updateCandidateText(candidate.id, $any($event.target).value)"
                      placeholder="A の文言を調整できます"
                    />
                  </label>

                  <div>
                    <p class="form-field__label">理由（仮説）</p>
                    <p>{{ candidate.rationale }}</p>
                  </div>

                  @if (candidate.questions?.length) {
                    <div>
                      <p class="form-field__label">確認したいこと</p>
                      <ul class="list-disc pl-5">
                        @for (question of candidate.questions ?? []; track $index) {
                          <li>{{ question }}</li>
                        }
                      </ul>
                    </div>
                  }

                  @if (candidate.evidence?.length) {
                    <div class="flex flex-col gap-2">
                      <p class="form-field__label">根拠</p>
                      <ul class="flex flex-col gap-2">
                        @for (evidence of candidate.evidence ?? []; track $index) {
                          <li class="flex flex-col gap-1">
                            <div class="flex flex-wrap items-center gap-2">
                              <span class="page-badge">{{ formatEvidenceType(evidence.type) }}</span>
                              @if (evidence.timestamp) {
                                <time>{{ evidence.timestamp }}</time>
                              }
                            </div>
                            <p class="form-note">
                              {{ evidence.snippet || evidence.id || '参照あり' }}
                            </p>
                          </li>
                        }
                      </ul>
                    </div>
                  }
                </article>
              }
            </div>
          }

          @if (advancedMode()) {
            <div class="surface-card flex flex-col gap-4">
              <div>
                <h4 class="page-section__title">手入力で A を追加</h4>
                <p class="page-section__subtitle">1 行に 1 件ずつ入力してください。</p>
              </div>
              <div class="form-grid form-grid--two">
                <label class="form-field">
                  <span class="form-field__label">やるべき</span>
                  <textarea
                    class="form-control form-control--textarea"
                    placeholder="例: 計画した学習時間を確保する"
                    [value]="shouldText()"
                    (input)="updateShouldText($any($event.target).value)"
                  ></textarea>
                </label>
                <label class="form-field">
                  <span class="form-field__label">やれない</span>
                  <textarea
                    class="form-control form-control--textarea"
                    placeholder="例: 夕方に集中力が続かない"
                    [value]="cannotText()"
                    (input)="updateCannotText($any($event.target).value)"
                  ></textarea>
                </label>
                <label class="form-field">
                  <span class="form-field__label">やりたい</span>
                  <textarea
                    class="form-control form-control--textarea"
                    placeholder="例: 週末に振り返りの時間を作りたい"
                    [value]="wantText()"
                    (input)="updateWantText($any($event.target).value)"
                  ></textarea>
                </label>
              </div>
              <label class="form-field form-field--full">
                <span class="form-field__label">追加コンテキスト</span>
                <textarea
                  class="form-control form-control--textarea"
                  placeholder="補足したい背景や状況を入力してください"
                  [value]="contextText()"
                  (input)="updateContextText($any($event.target).value)"
                ></textarea>
                <p class="form-note">
                  追加コンテキストは自動補完と組み合わせて AI に渡します。
                </p>
              </label>
            </div>
          }

          <div class="form-actions">
            <button
              type="button"
              class="button button--primary"
              (click)="generateImmunityMap()"
              [disabled]="isGenerating()"
              [attr.aria-busy]="isGenerating()"
            >
              <span
                class="button__spinner"
                aria-hidden="true"
                [class.button__spinner--visible]="isGenerating()"
              ></span>
              <span class="button__label">{{ isGenerating() ? '生成中…' : '免疫マップを生成' }}</span>
            </button>
          </div>

          @if (generationError()) {
            <p class="app-alert app-alert--error" role="alert">
              {{ generationError() }}
            </p>
          }
        </div>
      </section>

      <section class="surface-panel page-panel analytics-immunity-map__results">
        <div class="flex flex-col gap-4">
          <header class="page-section__header">
            <div>
              <h3 class="page-section__title">生成結果</h3>
              <p class="page-section__subtitle">読み解きカードと Mermaid を確認できます。</p>
            </div>
            <div class="page-section__actions">
              <a
                class="button button--ghost button--pill"
                href="https://mermaid.live/"
                target="_blank"
                rel="noreferrer"
              >
                Mermaid Live Editor
              </a>
            </div>
          </header>

          @if (isGenerating()) {
            <div class="page-state" role="status" aria-live="polite">
              <h2>免疫マップを生成しています</h2>
              <p>AI がマップと読み解きを準備しています...</p>
            </div>
          } @else if (generatedMap(); as generated) {
            @if (generated.summary) {
              <div class="surface-card flex flex-col gap-2">
                <p class="form-field__label">サマリー</p>
                <p>{{ generated.summary }}</p>
              </div>
            }

            @if (generated.readout_cards?.length) {
              <div class="flex flex-col gap-3">
                <h4 class="page-section__title">読み解きカード</h4>
                <div class="flex flex-col gap-3">
                  @for (card of generated.readout_cards ?? []; track $index) {
                    <article class="surface-card flex flex-col gap-2">
                      <div class="flex flex-wrap items-center gap-2">
                        <span class="page-badge page-badge--accent">
                          {{ formatReadoutKind(card.kind) }}
                        </span>
                        <span class="form-field__label">{{ card.title }}</span>
                      </div>
                      <p>{{ card.body }}</p>
                      @if (card.evidence?.length) {
                        <div class="flex flex-col gap-2">
                          <p class="form-field__label">根拠</p>
                          <ul class="flex flex-col gap-2">
                            @for (evidence of card.evidence ?? []; track $index) {
                              <li class="flex flex-col gap-1">
                                <div class="flex flex-wrap items-center gap-2">
                                  <span class="page-badge">
                                    {{ formatEvidenceType(evidence.type) }}
                                  </span>
                                  @if (evidence.timestamp) {
                                    <time>{{ evidence.timestamp }}</time>
                                  }
                                </div>
                                <p class="form-note">
                                  {{ evidence.snippet || evidence.id || '参照あり' }}
                                </p>
                              </li>
                            }
                          </ul>
                        </div>
                      }
                    </article>
                  }
                </div>
              </div>
            }

            <label class="form-field">
              <span class="form-field__label">Mermaid</span>
              <textarea
                class="form-control form-control--textarea"
                [value]="generated.mermaid"
                readonly
                rows="12"
              ></textarea>
            </label>
            <div class="form-actions">
              <button type="button" class="button button--secondary" (click)="copyMermaid()">
                Mermaid をコピー
              </button>
              @if (copyStatus() === 'copied') {
                <span class="form-note">コピーしました。</span>
              } @else if (copyStatus() === 'failed') {
                <span class="form-note">コピーに失敗しました。</span>
              }
            </div>
          } @else {
            <div class="page-state">
              <h2>まだ生成されていません</h2>
              <p>A 候補を選択して免疫マップを生成してください。</p>
            </div>
          }
        </div>
      </section>
    </div>
  </section>
</app-page-layout>
