<app-page-layout
  class="analytics-page"
  eyebrow="分析ダッシュボード"
  title="ワークスペース全体の状況"
  description="進捗・ステータス・ラベルの内訳をまとめて確認できます。"
  headingLevel="h1"
>
  <section class="page-section analytics-page__intro">
    <div class="analytics-page__intro-content">
      <p>日々のタスク実行状況を俯瞰して、次の一手を決めやすくします。</p>
    </div>
    <div class="analytics-page__intro-actions">
      <a routerLink="/profile/evaluations" class="button button--secondary button--pill">
        最新の評価を確認
        <svg
          aria-hidden="true"
          viewBox="0 0 24 24"
          class="analytics-page__intro-icon"
          fill="none"
          stroke="currentColor"
          stroke-width="1.8"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>
  </section>

  @if (summarySignal(); as summary) {
    <section class="page-section analytics-summary">
      <ul class="page-list analytics-summary__metrics">
        <li class="page-list__item analytics-summary__metric">
          <p class="analytics-summary__eyebrow">進捗率</p>
          <p class="analytics-summary__value">{{ summary.progressRatio }}%</p>
          <p class="analytics-summary__note">完了カード {{ summary.doneCards }}/{{ summary.totalCards }}</p>
        </li>
        <li class="page-list__item analytics-summary__metric">
          <p class="analytics-summary__eyebrow">カード総数</p>
          <p class="analytics-summary__value">{{ summary.totalCards }}</p>
          <p class="analytics-summary__note">利用中のラベル {{ summary.activeLabels }}</p>
        </li>
        <li class="page-list__item analytics-summary__metric">
          <p class="analytics-summary__eyebrow">完了ポイント</p>
          <p class="analytics-summary__value">{{ pointSummary().done }}</p>
          <p class="analytics-summary__note">残り {{ pointSummary().remaining }}</p>
        </li>
        <li class="page-list__item analytics-summary__metric">
          <p class="analytics-summary__eyebrow">総ポイント</p>
          <p class="analytics-summary__value">{{ pointSummary().total }}</p>
          <p class="analytics-summary__note">負荷の目安として活用できます</p>
        </li>
      </ul>
    </section>
  }

  <div class="grid gap-4 lg:grid-cols-2">
    <section class="page-section analytics-breakdown">
      <header class="page-section__header">
        <h3 class="page-section__title">ステータス別の件数</h3>
        <span class="page-section__subtitle">{{ statusBreakdown().length }} ステージ</span>
      </header>
      <ul class="page-list analytics-breakdown__list">
        @for (item of statusBreakdown(); track item.id) {
          <li class="page-list__item analytics-breakdown__item">
            <span class="analytics-breakdown__swatch" [style.backgroundColor]="item.color"></span>
            <span class="analytics-breakdown__label">{{ item.name }}</span>
            <span class="analytics-breakdown__value">{{ item.total }}</span>
          </li>
        }
      </ul>
    </section>

    <section class="page-section analytics-breakdown">
      <header class="page-section__header">
        <h3 class="page-section__title">ラベル別の件数</h3>
        <span class="page-section__subtitle">{{ labelBreakdown().length }} ラベル</span>
      </header>
      <ul class="page-list analytics-breakdown__list">
        @for (item of labelBreakdown(); track item.id) {
          <li class="page-list__item analytics-breakdown__item">
            <span class="analytics-breakdown__swatch" [style.backgroundColor]="item.color"></span>
            <span class="analytics-breakdown__label">{{ item.name }}</span>
            <span class="analytics-breakdown__value">{{ item.total }}</span>
          </li>
        }
      </ul>
    </section>
  </div>

  <section class="surface-panel space-y-6 px-6 py-6">
    <header class="space-y-2">
      <h3 class="text-lg font-semibold text-on-surface">免疫マップ（Mermaid）</h3>
      <p class="text-xs text-slate-500">
        AI が免疫マップ構造（A〜F）を推測し、Mermaid 形式で出力します。内容がない要素・線は表示しません。
      </p>
    </header>

    <div class="grid gap-4 lg:grid-cols-3">
      <div class="space-y-2">
        <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400"
          >A：やるべきこと</label
        >
        <textarea
          class="w-full rounded-2xl border border-subtle bg-surface px-4 py-3 text-sm text-on-surface"
          rows="5"
          placeholder="例）週次レポートを出す"
          [value]="shouldText()"
          (input)="updateShouldText($any($event.target).value)"
        ></textarea>
      </div>

      <div class="space-y-2">
        <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400"
          >A：やれないこと</label
        >
        <textarea
          class="w-full rounded-2xl border border-subtle bg-surface px-4 py-3 text-sm text-on-surface"
          rows="5"
          placeholder="例）まとまった作業時間が取れない"
          [value]="cannotText()"
          (input)="updateCannotText($any($event.target).value)"
        ></textarea>
      </div>

      <div class="space-y-2">
        <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400"
          >A：やりたいこと</label
        >
        <textarea
          class="w-full rounded-2xl border border-subtle bg-surface px-4 py-3 text-sm text-on-surface"
          rows="5"
          placeholder="例）深い集中で品質を上げたい"
          [value]="wantText()"
          (input)="updateWantText($any($event.target).value)"
        ></textarea>
      </div>
    </div>

    <div class="space-y-2">
      <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400"
        >背景（任意）</label
      >
      <textarea
        class="w-full rounded-2xl border border-subtle bg-surface px-4 py-3 text-sm text-on-surface"
        rows="3"
        placeholder="例）直近の状況、制約、関係者、重要視していること など"
        [value]="contextText()"
        (input)="updateContextText($any($event.target).value)"
      ></textarea>
    </div>

    <div class="flex flex-wrap items-center justify-between gap-3">
      <p class="text-xs text-slate-500">
        出力は Mermaid Live Editor へ貼り付けて可視化できます（`https://mermaid.live`）。
      </p>
      <button
        type="button"
        class="button button--primary"
        [disabled]="isGenerating()"
        (click)="generateImmunityMap()"
      >
        {{ isGenerating() ? '生成中…' : '免疫マップを生成' }}
      </button>
    </div>

    @if (generationError(); as error) {
      <p class="text-sm font-medium text-rose-600" role="alert">{{ error }}</p>
    }

    @if (generatedMap(); as result) {
      <div class="space-y-3">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="text-xs text-slate-500">
            @if (result.model) {
              <span>model: {{ result.model }}</span>
            }
          </div>
          <div class="flex items-center gap-2">
            <button type="button" class="button button--secondary" (click)="copyMermaid()">
              Mermaid をコピー
            </button>
            <a
              class="button button--secondary"
              href="https://mermaid.live"
              target="_blank"
              rel="noopener noreferrer"
              >Mermaid Live Editor</a
            >
          </div>
        </div>

        @if (copyStatus() === 'copied') {
          <p class="text-xs font-medium text-emerald-600" role="status">コピーしました。</p>
        } @else if (copyStatus() === 'failed') {
          <p class="text-xs font-medium text-rose-600" role="alert">コピーに失敗しました。</p>
        }

        <textarea class="report-preview" rows="14" readonly [value]="result.mermaid"></textarea>

        @if (result.summary) {
          <p class="text-xs text-slate-500">{{ result.summary }}</p>
        }
      </div>
    }
  </section>
</app-page-layout>
