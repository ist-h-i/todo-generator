<app-page-layout
  class="settings-page"
  eyebrow="Workspace Settings"
  title="ワークスペース設定"
  description="ステータスやラベル、テンプレートを更新してチームの運用に合わせましょう。"
  headingLevel="h1"
>
  <div class="page-grid page-grid--two settings-page__grid">
    <section class="page-section settings-panel">
      <header class="page-section__header">
        <h3 class="page-section__title">ステータス設定</h3>
        <p class="page-section__subtitle">
          ステータスの順序やカテゴリーを管理し、ボードの列と一致させましょう。
        </p>
      </header>

      <ul class="page-list settings-status-list">
        @for (status of settingsSignal().statuses; track status.id) {
          <li class="page-list__item settings-status">
            <div class="page-list__heading settings-status__header">
              <div class="settings-status__meta">
                <span class="settings-status__swatch" [style.backgroundColor]="status.color"></span>
                <span class="page-list__title">{{ status.name }}</span>
                <span class="settings-status__category">{{ status.category }}</span>
              </div>
              <div class="settings-status__actions">
                <span class="settings-status__order">表示順 {{ status.order }}</span>
                <button
                  type="button"
                  class="button button--ghost button--pill"
                  [disabled]="statusCount() <= 1"
                  (click)="removeStatus(status.id)"
                >
                  削除
                </button>
              </div>
            </div>
          </li>
        }
      </ul>

      <form class="page-form settings-form" (submit)="saveStatus($event)">
        <div class="form-grid form-grid--two">
          <label class="form-field">
            <span class="form-field__label" for="status-name">ステータス名</span>
            <input
              id="status-name"
              type="text"
              class="form-control"
              placeholder="例: QA Review"
              [value]="statusForm.controls.name.value()"
              (input)="statusForm.controls.name.setValue($any($event.target).value)"
            />
          </label>
          <label class="form-field settings-color-field">
            <span class="form-field__label" for="status-color">表示色</span>
            <input
              id="status-color"
              type="color"
              class="form-control settings-color-picker"
              [value]="statusForm.controls.color.value()"
              (input)="statusForm.controls.color.setValue($any($event.target).value)"
            />
          </label>
        </div>
        <div class="form-field form-field--full">
          <span class="form-field__label">カテゴリー</span>
          <div class="settings-chip-group">
            <button
              type="button"
              class="button button--ghost button--pill"
              (click)="statusForm.controls.category.setValue('todo')"
            >
              TODO
            </button>
            <button
              type="button"
              class="button button--ghost button--pill"
              (click)="statusForm.controls.category.setValue('in-progress')"
            >
              IN PROGRESS
            </button>
            <button
              type="button"
              class="button button--ghost button--pill"
              (click)="statusForm.controls.category.setValue('done')"
            >
              DONE
            </button>
          </div>
          <p class="form-note">現在: {{ statusForm.controls.category.value() }}</p>
        </div>
        <div class="form-actions">
          <button type="submit" class="button button--primary">ステータスを追加</button>
        </div>
      </form>
    </section>

    <section class="page-section settings-panel">
      <header class="page-section__header">
        <h3 class="page-section__title">ラベル設定</h3>
        <p class="page-section__subtitle">カードに付与する分類ラベルを整理します。</p>
      </header>

      <ul class="page-list settings-label-list">
        @for (label of settingsSignal().labels; track label.id) {
          <li class="page-list__item settings-label">
            <div class="page-list__heading settings-label__header">
              <div class="settings-label__meta">
                <span class="settings-label__swatch" [style.backgroundColor]="label.color"></span>
                <span class="page-list__title">{{ label.name }}</span>
              </div>
              <div class="settings-label__actions">
                <span class="settings-label__id">{{ label.id }}</span>
                <button
                  type="button"
                  class="button button--ghost button--pill"
                  (click)="removeLabel(label.id)"
                >
                  削除
                </button>
              </div>
            </div>
          </li>
        }
      </ul>

      <form class="page-form settings-form" (submit)="saveLabel($event)">
        <div class="form-grid form-grid--two">
          <label class="form-field">
            <span class="form-field__label" for="label-name">ラベル名</span>
            <input
              id="label-name"
              type="text"
              class="form-control"
              placeholder="例: DevOps"
              [value]="labelForm.controls.name.value()"
              (input)="labelForm.controls.name.setValue($any($event.target).value)"
            />
          </label>
          <label class="form-field settings-color-field">
            <span class="form-field__label" for="label-color">表示色</span>
            <input
              id="label-color"
              type="color"
              class="form-control settings-color-picker"
              [value]="labelForm.controls.color.value()"
              (input)="labelForm.controls.color.setValue($any($event.target).value)"
            />
          </label>
        </div>
        <div class="form-actions">
          <button type="submit" class="button button--primary">ラベルを追加</button>
        </div>
      </form>
    </section>
  </div>

  <section class="page-section settings-panel">
    <header class="page-section__header">
      <h3 class="page-section__title">テンプレート</h3>
      <p class="page-section__subtitle">
        AI 提案から生成されるカードの初期設定をテンプレートとして管理します。
      </p>
    </header>

    <ul class="page-list settings-template-list">
      @for (template of settingsSignal().templates; track template.id) {
        <li class="page-list__item settings-template">
          <div class="settings-template__header">
            <div class="settings-template__identity">
              <h4 class="settings-template__title">{{ template.name }}</h4>
              <span class="page-badge">{{ template.id }}</span>
            </div>
            <div class="settings-template__actions">
              @if (editingTemplateId() === template.id) {
                <button
                  type="button"
                  class="button button--ghost button--pill"
                  (click)="cancelTemplateEdit()"
                >
                  キャンセル
                </button>
                <button
                  type="button"
                  class="button button--danger button--pill"
                  (click)="removeTemplate(template.id)"
                >
                  削除
                </button>
              } @else {
                <button
                  type="button"
                  class="button button--ghost button--pill"
                  (click)="openTemplateEditor(template)"
                >
                  編集
                </button>
                <button
                  type="button"
                  class="button button--danger button--pill"
                  (click)="removeTemplate(template.id)"
                >
                  削除
                </button>
              }
            </div>
          </div>

          @if (editingTemplateId() === template.id) {
            <form class="settings-template__editor" (submit)="updateTemplatePreset($event)">
              <div class="form-grid form-grid--two">
                <label class="form-field form-field--full">
                  <span class="form-field__label" [attr.for]="'template-edit-name-' + template.id"
                    >テンプレート名</span
                  >
                  <input
                    [attr.id]="'template-edit-name-' + template.id"
                    type="text"
                    class="form-control"
                    placeholder="例: スプリント改善"
                    [value]="templateEditForm.controls.name.value()"
                    (input)="templateEditForm.controls.name.setValue($any($event.target).value)"
                  />
                </label>

                <label class="form-field form-field--full">
                  <span
                    class="form-field__label"
                    [attr.for]="'template-edit-description-' + template.id"
                    >説明</span
                  >
                  <textarea
                    [attr.id]="'template-edit-description-' + template.id"
                    class="form-control form-control--textarea"
                    placeholder="テンプレートの利用シーンを記載してください"
                    [value]="templateEditForm.controls.description.value()"
                    (input)="
                      templateEditForm.controls.description.setValue($any($event.target).value)
                    "
                  ></textarea>
                </label>

                <label class="form-field">
                  <span class="form-field__label" [attr.for]="'template-edit-status-' + template.id"
                    >初期ステータス</span
                  >
                  <select
                    [attr.id]="'template-edit-status-' + template.id"
                    class="form-control"
                    [value]="templateEditForm.controls.defaultStatusId.value()"
                    (change)="
                      templateEditForm.controls.defaultStatusId.setValue($any($event.target).value)
                    "
                  >
                    @for (status of settingsSignal().statuses; track status.id) {
                      <option [value]="status.id">{{ status.name }}</option>
                    }
                  </select>
                </label>

                <label class="form-field">
                  <span
                    class="form-field__label"
                    [attr.for]="'template-edit-threshold-' + template.id"
                    >おすすめ度しきい値 (%)</span
                  >
                  <input
                    [attr.id]="'template-edit-threshold-' + template.id"
                    type="number"
                    min="0"
                    max="100"
                    step="5"
                    class="form-control"
                    [value]="templateEditForm.controls.confidenceThreshold.value()"
                    (input)="
                      updateConfidenceThreshold(
                        templateEditForm.controls.confidenceThreshold,
                        $any($event.target).valueAsNumber
                      )
                    "
                  />
                </label>
              </div>

              <div class="form-field form-field--full">
                <span class="form-field__label">初期ラベル</span>
                <div class="settings-checkbox-group">
                  @for (label of settingsSignal().labels; track label.id) {
                    <label class="settings-checkbox">
                      <input
                        type="checkbox"
                        [checked]="
                          templateEditForm.controls.defaultLabelIds.value().includes(label.id)
                        "
                        (change)="toggleEditTemplateLabel(label.id, $any($event.target).checked)"
                      />
                      <span>{{ label.name }}</span>
                    </label>
                  }
                  @if (settingsSignal().labels.length === 0) {
                    <span class="settings-checkbox__empty">ラベルが未設定です</span>
                  }
                </div>
              </div>

              <div class="form-field form-field--full">
                <span class="form-field__label">表示フィールド</span>
                <div class="settings-checkbox-group">
                  <label class="settings-checkbox">
                    <input
                      type="checkbox"
                      [checked]="templateEditForm.controls.showStoryPoints.value()"
                      (change)="
                        templateEditForm.controls.showStoryPoints.setValue(
                          $any($event.target).checked
                        )
                      "
                    />
                    <span>ストーリーポイント</span>
                  </label>
                  <label class="settings-checkbox">
                    <input
                      type="checkbox"
                      [checked]="templateEditForm.controls.showDueDate.value()"
                      (change)="
                        templateEditForm.controls.showDueDate.setValue($any($event.target).checked)
                      "
                    />
                    <span>期限</span>
                  </label>
                  <label class="settings-checkbox">
                    <input
                      type="checkbox"
                      [checked]="templateEditForm.controls.showAssignee.value()"
                      (change)="
                        templateEditForm.controls.showAssignee.setValue($any($event.target).checked)
                      "
                    />
                    <span>担当</span>
                  </label>
                  <label class="settings-checkbox">
                    <input
                      type="checkbox"
                      [checked]="templateEditForm.controls.showConfidence.value()"
                      (change)="
                        templateEditForm.controls.showConfidence.setValue(
                          $any($event.target).checked
                        )
                      "
                    />
                    <span>AIおすすめ度</span>
                  </label>
                </div>
              </div>

              <div class="form-actions">
                <button type="submit" class="button button--primary">変更を保存</button>
                <button type="button" class="button button--ghost" (click)="cancelTemplateEdit()">
                  キャンセル
                </button>
              </div>
            </form>
          } @else {
            <p class="settings-template__description">
              {{ template.description || '説明は設定されていません。' }}
            </p>

            <div class="settings-template__meta">
              <span class="page-badge page-badge--accent"
                >初期ステータス: {{ template.defaultStatusId }}</span
              >
              <span class="page-badge"
                >おすすめ度しきい値: {{ template.confidenceThreshold | number: '1.0-0' }}%</span
              >
            </div>

            <div class="settings-template__labels">
              <p class="settings-template__labels-title">初期ラベル</p>
              <div class="settings-template__labels-list">
                @if (template.defaultLabelIds.length > 0) {
                  @for (labelId of template.defaultLabelIds; track labelId) {
                    <span class="surface-pill px-3 py-1">
                      {{ labelsById().get(labelId) ?? labelId }}
                    </span>
                  }
                } @else {
                  <span class="surface-pill px-3 py-1 text-slate-400">選択なし</span>
                }
              </div>
            </div>
          }
        </li>
      }
    </ul>

    <form class="page-form settings-form" (submit)="saveTemplatePreset($event)">
      <h4 class="settings-form__title">テンプレートを追加</h4>

      <div class="form-grid form-grid--two">
        <label class="form-field form-field--full">
          <span class="form-field__label" for="template-name">テンプレート名</span>
          <input
            id="template-name"
            type="text"
            class="form-control"
            placeholder="例: スプリント改善"
            [value]="templateForm.controls.name.value()"
            (input)="templateForm.controls.name.setValue($any($event.target).value)"
          />
        </label>

        <label class="form-field form-field--full">
          <span class="form-field__label" for="template-description">説明</span>
          <textarea
            id="template-description"
            class="form-control form-control--textarea"
            placeholder="テンプレートの利用シーンを記載してください"
            [value]="templateForm.controls.description.value()"
            (input)="templateForm.controls.description.setValue($any($event.target).value)"
          ></textarea>
        </label>

        <label class="form-field">
          <span class="form-field__label" for="template-status">初期ステータス</span>
          <select
            id="template-status"
            class="form-control"
            [value]="templateForm.controls.defaultStatusId.value()"
            (change)="templateForm.controls.defaultStatusId.setValue($any($event.target).value)"
          >
            @for (status of settingsSignal().statuses; track status.id) {
              <option [value]="status.id">{{ status.name }}</option>
            }
          </select>
        </label>

        <label class="form-field">
          <span class="form-field__label" for="template-threshold">おすすめ度しきい値 (%)</span>
          <input
            id="template-threshold"
            type="number"
            min="0"
            max="100"
            step="5"
            class="form-control"
            [value]="templateForm.controls.confidenceThreshold.value()"
            (input)="
              updateConfidenceThreshold(
                templateForm.controls.confidenceThreshold,
                $any($event.target).valueAsNumber
              )
            "
          />
        </label>
      </div>

      <div class="form-field form-field--full">
        <span class="form-field__label">初期ラベル</span>
        <div class="settings-checkbox-group">
          @for (label of settingsSignal().labels; track label.id) {
            <label class="settings-checkbox">
              <input
                type="checkbox"
                [checked]="templateForm.controls.defaultLabelIds.value().includes(label.id)"
                (change)="toggleCreateTemplateLabel(label.id, $any($event.target).checked)"
              />
              <span>{{ label.name }}</span>
            </label>
          }
          @if (settingsSignal().labels.length === 0) {
            <span class="settings-checkbox__empty">ラベルが未設定です</span>
          }
        </div>
      </div>

      <div class="form-field form-field--full">
        <span class="form-field__label">表示フィールド</span>
        <div class="settings-checkbox-group">
          <label class="settings-checkbox">
            <input
              type="checkbox"
              [checked]="templateForm.controls.showStoryPoints.value()"
              (change)="templateForm.controls.showStoryPoints.setValue($any($event.target).checked)"
            />
            <span>ストーリーポイント</span>
          </label>
          <label class="settings-checkbox">
            <input
              type="checkbox"
              [checked]="templateForm.controls.showDueDate.value()"
              (change)="templateForm.controls.showDueDate.setValue($any($event.target).checked)"
            />
            <span>期限</span>
          </label>
          <label class="settings-checkbox">
            <input
              type="checkbox"
              [checked]="templateForm.controls.showAssignee.value()"
              (change)="templateForm.controls.showAssignee.setValue($any($event.target).checked)"
            />
            <span>担当</span>
          </label>
          <label class="settings-checkbox">
            <input
              type="checkbox"
              [checked]="templateForm.controls.showConfidence.value()"
              (change)="templateForm.controls.showConfidence.setValue($any($event.target).checked)"
            />
            <span>AIおすすめ度</span>
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="button button--primary">テンプレートを追加</button>
      </div>
    </form>
  </section>
</app-page-layout>
