<app-page-layout
  class="analyze-page"
  eyebrow="AI Task Creator"
  title="メモからタスクを起票"
  description="作業メモやアイデアを貼り付けると、AI がカード案とサブタスクを提案します。内容を確認し、必要なものだけボードへ追加しましょう。"
  headingLevel="h1"
>
  <form class="surface-panel page-panel analyze-page__form" (submit)="handleSubmit($event)">
    <div class="form-grid form-grid--two analyze-page__composer">
      <label class="form-field analyze-page__notes">
        <span class="form-field__label">ノート</span>
        <p class="form-note analyze-page__notes-hint">
          具体的な課題や観察した事実をまとめると、より正確なカード案が生成されます。
        </p>
        <textarea
          class="form-control form-control--textarea analyze-page__notes-input"
          placeholder="例: ユーザーからのフィードバックや不具合の状況を貼り付けてください"
          [value]="analyzeForm.controls.notes.value()"
          (input)="analyzeForm.controls.notes.setValue($any($event.target).value)"
        ></textarea>
      </label>

      <div class="analyze-page__objective">
        <p class="analyze-page__objective-eyebrow">ゴールの決め方</p>
        <p class="analyze-page__objective-hint">
          タスク案を作成するときのゴールの決め方を選んでください。
        </p>

        <div class="analyze-page__options" role="radiogroup" aria-label="ゴールの決め方">
          <label
            class="analyze-page__option"
            [class.analyze-page__option--active]="isAutoObjectiveEnabled()"
          >
            <input
              type="radio"
              name="autoObjective"
              [checked]="isAutoObjectiveEnabled()"
              (change)="analyzeForm.controls.autoObjective.setValue(true)"
              class="analyze-page__option-input focus-ring"
            />
            <span class="analyze-page__option-body">
              <span class="analyze-page__option-title">AIにおまかせ</span>
              <span class="analyze-page__option-description">
                ノートの内容から AI がおすすめのゴールを自動設定します。
              </span>
            </span>
          </label>

          <label
            class="analyze-page__option"
            [class.analyze-page__option--active]="!isAutoObjectiveEnabled()"
          >
            <input
              type="radio"
              name="autoObjective"
              [checked]="!isAutoObjectiveEnabled()"
              (change)="analyzeForm.controls.autoObjective.setValue(false)"
              class="analyze-page__option-input focus-ring"
            />
            <span class="analyze-page__option-body">
              <span class="analyze-page__option-title">自分で指定</span>
              <span class="analyze-page__option-description">
                ゴールを詳しく入力して AI に具体的な提案を依頼します。
              </span>
            </span>
          </label>
        </div>

        @if (isAutoObjectiveEnabled()) {
          <div class="surface-card analyze-page__objective-preview" aria-live="polite">
            <h3 class="analyze-page__preview-title">AIが推定したゴール候補</h3>
            <p class="analyze-page__preview-body">{{ autoObjectivePreview() }}</p>
            <p class="analyze-page__preview-hint">
              提案を作成すると、このゴールを前提にカード案が作成されます。
            </p>
          </div>
        } @else {
          <label class="form-field analyze-page__objective-manual">
            <span class="form-field__label">ゴール</span>
            <textarea
              class="form-control form-control--textarea"
              placeholder="例: 新規登録フローの離脱率を20%改善する"
              [value]="analyzeForm.controls.objective.value()"
              (input)="analyzeForm.controls.objective.setValue($any($event.target).value)"
            ></textarea>
            <p class="form-note">
              ゴールは AI
              がタスク案を組み立てる際の到達点になります。できるだけ具体的に記載してください。
            </p>
          </label>
        }
      </div>
    </div>

    <div class="form-actions analyze-page__form-actions">
      <button
        type="submit"
        class="button button--primary analyze-page__submit"
        [disabled]="isSubmitDisabled()"
        [attr.aria-busy]="isAnalyzing()"
      >
        <span
          class="button__spinner"
          aria-hidden="true"
          [class.button__spinner--visible]="isAnalyzing()"
        ></span>
        <span class="button__label">{{ isAnalyzing() ? '生成中…' : 'タスク案を作成' }}</span>
      </button>
      <button type="button" class="button button--ghost" (click)="resetForm()">
        入力をリセット
      </button>
    </div>
  </form>

  @if (generationToast(); as toastState) {
    <div
      class="analyze-page__toast"
      [attr.data-state]="toastState"
      [attr.role]="toastState === 'error' ? 'alert' : 'status'"
      [attr.aria-live]="toastState === 'error' ? 'assertive' : 'polite'"
    >
      @if (toastState === 'loading') {
        <span class="analyze-page__toast-spinner" aria-hidden="true"></span>
      } @else if (toastState === 'error') {
        <svg
          class="analyze-page__toast-icon analyze-page__toast-icon--error"
          aria-hidden="true"
          viewBox="0 0 24 24"
          focusable="false"
        >
          <path
            d="M13.41 12 18.7 6.71a1 1 0 1 0-1.41-1.41L12 10.59 6.71 5.3a1 1 0 0 0-1.41 1.41L10.59 12l-5.3 5.29a1 1 0 1 0 1.41 1.41L12 13.41l5.29 5.29a1 1 0 0 0 1.41-1.41Z"
          />
        </svg>
      } @else {
        <svg
          class="analyze-page__toast-icon"
          aria-hidden="true"
          viewBox="0 0 24 24"
          focusable="false"
        >
          <path
            d="M9.5 16.2 5.3 12a1 1 0 0 1 1.4-1.4l2.8 2.79 7.09-7.09a1 1 0 1 1 1.42 1.42l-7.8 7.8a1 1 0 0 1-1.41 0Z"
          />
        </svg>
      }
      <span class="analyze-page__toast-message">{{ generationToastMessage() }}</span>
    </div>
  }

  <section
    class="page-section analyze-page__results"
    [class.analyze-page__results--highlight]="shouldHighlightResults()"
    aria-live="polite"
  >
    <header class="page-section__header analyze-page__results-header">
      <div>
        <p class="analyze-page__results-eyebrow">AI Suggestions</p>
        <h3 class="page-section__title">AI が作成したタスク案</h3>
        <p class="page-section__subtitle">
          ノートとゴールをもとに、優先度付きのカード案とサブタスクを提案します。
        </p>
      </div>
      <div class="page-section__actions">
        <button type="button" class="button button--ghost button--pill" (click)="resetForm()">
          結果をクリア
        </button>
      </div>
    </header>

    @if (proposalPublishFeedback(); as feedback) {
      <div
        class="analyze-page__toast analyze-page__toast--inline"
        role="status"
        aria-live="polite"
        [attr.data-state]="feedback.status"
      >
        @if (feedback.status === 'success') {
          <svg
            class="analyze-page__toast-icon"
            aria-hidden="true"
            viewBox="0 0 24 24"
            focusable="false"
          >
            <path
              d="M9.5 16.2 5.3 12a1 1 0 0 1 1.4-1.4l2.8 2.79 7.09-7.09a1 1 0 1 1 1.42 1.42l-7.8 7.8a1 1 0 0 1-1.41 0Z"
            />
          </svg>
        } @else {
          <svg
            class="analyze-page__toast-icon analyze-page__toast-icon--error"
            aria-hidden="true"
            viewBox="0 0 24 24"
            focusable="false"
          >
            <path
              d="M13.41 12 18.7 6.71a1 1 0 1 0-1.41-1.41L12 10.59 6.71 5.3a1 1 0 0 0-1.41 1.41L10.59 12l-5.3 5.29a1 1 0 1 0 1.41 1.41L12 13.41l5.29 5.29a1 1 0 0 0 1.41-1.41Z"
            />
          </svg>
        }
        <span class="analyze-page__toast-message">{{ feedback.message }}</span>
      </div>
    }

    @if (isAnalyzing()) {
      <div class="page-state analyze-page__state analyze-page__state--loading" role="status">
        <span class="analyze-page__loader" aria-hidden="true"></span>
        <div class="analyze-page__state-body">
          <h2>タスク案を生成しています</h2>
          <p>AI がタスク案を準備しています...</p>
        </div>
      </div>
    }

    @if (analysisResource.error()) {
      <p class="app-alert app-alert--error">
        タスク起票の処理中にエラーが発生しました。内容を確認してからもう一度お試しください。
      </p>
    }

    @if (analysisResource.value()) {
      @if (hasEligibleProposals()) {
        <ul
          class="page-list analyze-page__proposal-list"
          [attr.data-animate]="shouldHighlightResults() ? 'incoming' : null"
        >
          @for (proposal of eligibleProposals(); track proposal.id; let index = $index) {
            <li
              class="page-list__item analyze-page__proposal"
              [class.analyze-page__proposal--incoming]="shouldHighlightResults()"
              [style.--proposal-index]="index"
            >
              <div class="analyze-page__proposal-header">
                <h4 class="analyze-page__proposal-title">{{ proposal.title }}</h4>
                <span class="page-badge page-badge--accent">
                  おすすめ度 {{ proposal.confidence * 100 | number: '1.0-0' }}%
                </span>
              </div>
              <p class="analyze-page__proposal-summary">{{ proposal.summary }}</p>
              <div class="analyze-page__proposal-tags">
                <span class="page-badge"> 推奨ステータス: {{ proposal.suggestedStatusId }} </span>
                <span class="page-badge">
                  推奨ラベル: {{ proposal.suggestedLabelIds.join(', ') }}
                </span>
              </div>
              <div class="analyze-page__proposal-subtasks">
                <p class="analyze-page__proposal-subtasks-title">サブタスク案</p>
                <ul class="analyze-page__proposal-subtasks-list">
                  @for (task of proposal.subtasks; track task) {
                    <li>{{ task }}</li>
                  }
                </ul>
              </div>
              <button
                type="button"
                class="button button--secondary"
                (click)="publishProposals([proposal])"
              >
                この案をカードに追加
              </button>
            </li>
          }
        </ul>
        <div class="analyze-page__proposal-actions">
          <button
            type="button"
            class="button button--primary"
            (click)="publishProposals(eligibleProposals())"
          >
            すべての案をボードに追加
          </button>
        </div>
      } @else {
        <div class="page-state analyze-page__state">
          <h2>表示できる提案がありません</h2>
          <p>おすすめ度のしきい値より低い案は表示されません。設定を見直して再度お試しください。</p>
        </div>
      }
    } @else {
      <div class="page-state analyze-page__state">
        <h2>提案がまだありません</h2>
        <p>ノートを入力してタスク起票を実行してください。</p>
      </div>
    }
  </section>
</app-page-layout>
