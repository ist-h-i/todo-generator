<app-page-layout
  class="report-assistant-page"
  eyebrow="AI レポートアシスタント"
  title="日報・週報解析"
  description="タグと本文を入力すると、AI がカード候補と振り返りの観点を提案します。"
  headingLevel="h1"
>
  <a appPageHeaderActions class="button button--secondary focus-ring" routerLink="/analytics">
    分析ダッシュボードを見る
  </a>

  <div class="app-alert app-alert--notice report-assistant-page__notice" role="status">
    解析に使用した本文はカード作成後に破棄され、ワークスペースに保存されません。
  </div>

  <div class="page-grid page-grid--two report-assistant-page__layout">
    <section class="surface-panel page-panel report-assistant-page__form">
      <header class="page-section__header">
        <h2 class="page-section__title">解析に送る内容を整理する</h2>
        <p class="page-section__subtitle">
          重要な出来事ごとにセクションを分けると、タスクや提案の精度が高まります。
        </p>
      </header>

      <form class="page-form" [formGroup]="form" (submit)="submit($event)" novalidate>
        <div class="form-grid form-grid--two">
          <div class="form-field form-field--full">
            <label class="form-field__label" for="tags">タグ</label>
            <input
              id="tags"
              type="text"
              class="form-control"
              formControlName="tags"
              placeholder="例: backend, 障害対応"
            />
            <p class="form-note">カンマまたはスペース区切りで入力すると複数タグを追加できます。</p>
          </div>
        </div>

        <div class="form-collection report-assistant-page__sections" formArrayName="sections">
          <header class="page-section__header">
            <h3 class="page-section__title">日報・週報セクション</h3>
            <p class="page-section__subtitle">
              セクション内の本文は必須です。見出しを付けると、カードのタイトルに反映されます。
            </p>
          </header>

          <div
            class="form-collection__item"
            *ngFor="let section of sections.controls; index as index"
            [formGroupName]="index"
          >
            <div class="form-collection__header">
              <h4 class="form-collection__title">セクション {{ index + 1 }}</h4>
              <button
                type="button"
                class="button button--ghost button--pill focus-ring"
                (click)="removeSection(index)"
                [disabled]="sections.length === 1"
              >
                削除
              </button>
            </div>

            <div class="form-grid form-grid--two report-assistant-page__section-grid">
              <div class="form-field">
                <label class="form-field__label">タイトル</label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="title"
                  placeholder="例: 対応内容"
                />
              </div>

              <div class="form-field form-field--full">
                <label class="form-field__label"> 本文 <span aria-hidden="true">*</span> </label>
                <textarea
                  class="form-control form-control--textarea"
                  formControlName="body"
                  rows="4"
                  placeholder="重要な出来事や気づきを入力してください"
                ></textarea>
              </div>
            </div>
          </div>

          <button type="button" class="button button--secondary focus-ring" (click)="addSection()">
            セクションを追加
          </button>
        </div>

        <div class="form-actions">
          <button type="submit" class="button button--primary focus-ring" [disabled]="pending()">
            解析を実行
          </button>
        </div>

        <div class="app-alert app-alert--error" *ngIf="error() as errorMessage" role="alert">
          {{ errorMessage }}
        </div>
        <div
          class="app-alert app-alert--success"
          *ngIf="successMessage() as successMessage"
          role="status"
        >
          {{ successMessage }}
        </div>
      </form>
    </section>

    <aside class="report-assistant-page__insights">
      <section
        class="surface-panel page-panel report-assistant-page__results"
        *ngIf="detail() as active; else emptyState"
      >
        <header class="page-section__header">
          <h2 class="page-section__title">解析結果</h2>
          <p class="page-section__subtitle">
            AI が抽出したタスク案とイベント履歴を確認し、必要に応じてボードへ追加してください。
          </p>
        </header>

        <div class="report-assistant-page__status-group">
          <span class="page-badge page-badge--accent">ステータス {{ active.status }}</span>
          <span class="page-badge">提案 {{ proposalControls.length }} 件</span>
        </div>

        <div class="app-alert app-alert--error" *ngIf="active.failure_reason" role="alert">
          失敗理由: {{ active.failure_reason }}
        </div>

        <section class="report-assistant-page__group">
          <header class="report-assistant-page__group-header">
            <h3 class="page-section__title">日報・週報本文</h3>
          </header>
          <ul class="page-list" aria-label="送信した日報の内容">
            <li class="page-list__item" *ngFor="let section of active.sections; index as index">
              <div class="page-list__heading">
                <p class="page-list__title">
                  {{ section.title || 'セクション ' + (index + 1) }}
                </p>
              </div>
              <p class="page-list__description">{{ section.body }}</p>
            </li>
          </ul>
        </section>

        <section class="report-assistant-page__group" *ngIf="active.cards.length > 0">
          <header class="report-assistant-page__group-header">
            <h3 class="page-section__title">生成されたタスク</h3>
          </header>
          <ul class="page-list" aria-label="生成されたタスク">
            <li class="page-list__item" *ngFor="let card of active.cards">
              <div class="page-list__heading">
                <p class="page-list__title">{{ card.title }}</p>
                <span class="page-badge page-badge--accent">
                  優先度 {{ card.priority || 'medium' }}
                </span>
              </div>
              <p class="page-list__description">{{ card.summary }}</p>
              <div class="report-assistant-page__subtasks" *ngIf="card.subtasks.length > 0">
                <span class="surface-pill px-3 py-1" *ngFor="let subtask of card.subtasks">
                  {{ subtask.title }}
                </span>
              </div>
            </li>
          </ul>
        </section>

        <section class="report-assistant-page__group">
          <header
            class="report-assistant-page__group-header report-assistant-page__group-header--with-action"
          >
            <div>
              <h3 class="page-section__title">提案中のタスク</h3>
              <p class="page-section__subtitle">
                必要な提案を個別にカードとして起票できます。内容を編集したり、提案を追加・削除したりできます。
              </p>
            </div>
            <button
              type="button"
              class="button button--secondary focus-ring"
              (click)="addProposal()"
            >
              提案を追加
            </button>
          </header>

          <div
            class="app-alert app-alert--success"
            *ngIf="publishSuccess() as successMessage"
            role="status"
          >
            {{ successMessage }}
          </div>
          <div
            class="app-alert app-alert--error"
            *ngIf="publishError() as errorMessage"
            role="alert"
          >
            {{ errorMessage }}
          </div>

          <ng-container *ngIf="proposalControls.length > 0; else emptyProposals">
            <ul class="page-list" aria-label="提案中のタスク">
              <li class="page-list__item" *ngFor="let proposal of proposalControls; index as index">
                <div class="report-assistant-page__proposal-editor" [formGroup]="proposal">
                  <div class="report-assistant-page__proposal-header">
                    <div class="form-field form-field--full">
                      <label class="form-field__label">
                        タイトル <span aria-hidden="true">*</span>
                      </label>
                      <input
                        type="text"
                        class="form-control"
                        formControlName="title"
                        placeholder="提案するタスクのタイトルを入力"
                      />
                    </div>
                    <div class="report-assistant-page__proposal-actions">
                      <button
                        type="button"
                        class="button button--secondary focus-ring"
                        (click)="publishProposal(index)"
                        [disabled]="publishPending()"
                      >
                        この提案をカードに追加
                      </button>
                      <button
                        type="button"
                        class="button button--ghost focus-ring"
                        (click)="removeProposal(index)"
                      >
                        提案を削除
                      </button>
                    </div>
                  </div>

                  <div class="form-field form-field--full">
                    <label class="form-field__label">
                      概要 <span aria-hidden="true">*</span>
                    </label>
                    <textarea
                      class="form-control form-control--textarea"
                      formControlName="summary"
                      rows="3"
                      placeholder="提案の背景や詳細を入力"
                    ></textarea>
                  </div>

                  <div class="form-grid form-grid--two report-assistant-page__proposal-grid">
                    <div class="form-field">
                      <label class="form-field__label">推奨ステータス</label>
                      <input
                        type="text"
                        class="form-control"
                        formControlName="status"
                        placeholder="例: In Progress"
                      />
                    </div>
                    <div class="form-field">
                      <label class="form-field__label">推奨ラベル</label>
                      <input
                        type="text"
                        class="form-control"
                        formControlName="labels"
                        placeholder="カンマまたはスペース区切りで入力"
                      />
                      <p class="form-note">例: backend, リリース準備</p>
                    </div>
                    <div class="form-field">
                      <label class="form-field__label">優先度</label>
                      <select class="form-control" formControlName="priority">
                        <option value="urgent">urgent</option>
                        <option value="high">high</option>
                        <option value="medium">medium</option>
                        <option value="low">low</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label class="form-field__label">期限目安 (日)</label>
                      <input
                        type="number"
                        class="form-control"
                        formControlName="dueInDays"
                        min="0"
                        placeholder="例: 3"
                      />
                    </div>
                  </div>

                  <div class="report-assistant-page__subtasks-editor" formArrayName="subtasks">
                    <header class="report-assistant-page__subtasks-header">
                      <h4 class="page-section__title">サブタスク</h4>
                      <button
                        type="button"
                        class="button button--ghost focus-ring"
                        (click)="addSubtask(index)"
                      >
                        サブタスクを追加
                      </button>
                    </header>

                    <ng-container *ngIf="proposalSubtasks(index).length > 0; else emptySubtasks">
                      <div
                        class="report-assistant-page__subtask-editor"
                        *ngFor="let subtask of proposalSubtasks(index).controls; index as subIndex"
                        [formGroupName]="subIndex"
                      >
                        <div class="form-grid form-grid--two">
                          <div class="form-field">
                            <label class="form-field__label">タイトル</label>
                            <input
                              type="text"
                              class="form-control"
                              formControlName="title"
                              placeholder="例: 調査"
                            />
                          </div>
                          <div class="form-field">
                            <label class="form-field__label">ステータス</label>
                            <input
                              type="text"
                              class="form-control"
                              formControlName="status"
                              placeholder="todo / in-progress / done"
                            />
                          </div>
                          <div class="form-field form-field--full">
                            <label class="form-field__label">詳細</label>
                            <textarea
                              class="form-control form-control--textarea"
                              formControlName="description"
                              rows="2"
                              placeholder="補足情報を入力"
                            ></textarea>
                          </div>
                        </div>
                        <div class="report-assistant-page__subtask-actions">
                          <button
                            type="button"
                            class="button button--ghost focus-ring"
                            (click)="removeSubtask(index, subIndex)"
                          >
                            サブタスクを削除
                          </button>
                        </div>
                      </div>
                    </ng-container>
                    <ng-template #emptySubtasks>
                      <p class="form-note">
                        サブタスクはまだありません。必要に応じて「サブタスクを追加」をクリックしてください。
                      </p>
                    </ng-template>
                  </div>
                </div>
              </li>
            </ul>
          </ng-container>
          <ng-template #emptyProposals>
            <p class="form-note">
              提案がありません。手動で提案を追加してカード化することもできます。
            </p>
          </ng-template>
        </section>

        <section class="report-assistant-page__group">
          <header class="report-assistant-page__group-header">
            <h3 class="page-section__title">イベント履歴</h3>
          </header>
          <ul class="page-list" aria-label="イベント履歴">
            <li class="page-list__item" *ngFor="let event of active.events">
              <div class="page-list__heading">
                <p class="page-list__title">{{ event.event_type }}</p>
              </div>
              <div class="page-list__meta">
                <span>{{ event.created_at | date: 'short' }}</span>
              </div>
            </li>
          </ul>
        </section>
      </section>

      <ng-template #emptyState>
        <section class="surface-panel page-panel report-assistant-page__results">
          <header class="page-section__header">
            <h2 class="page-section__title">解析結果</h2>
            <p class="page-section__subtitle">
              日報を送信すると、ここにカード案やイベントが表示されます。
            </p>
          </header>
          <div class="page-state" role="status">
            <h2>まだ解析結果がありません</h2>
            <p>フォームに日報を入力して AI 解析を実行すると、ここに提案が表示されます。</p>
            <p>解析後に本文は破棄されるため、履歴として保存されません。</p>
          </div>
        </section>
      </ng-template>
    </aside>
  </div>
</app-page-layout>
