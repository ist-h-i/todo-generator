<shared-page-layout
  class="report-assistant-page"
  eyebrow="AI レポートアシスタント"
  title="日報・週報解析"
  description="タグと本文を入力すると、AI がカード候補と振り返りの観点を提案します。"
  headingLevel="h1"
>
  <a appPageHeaderActions class="button button--secondary focus-ring" routerLink="/analytics">
    分析ダッシュボードを見る
  </a>

  <div class="app-alert app-alert--notice report-assistant-page__notice" role="status">
    入力した本文は日報・週報の履歴として保存され、免疫マップ生成のコンテキストにも利用されます。機密情報は入力しないでください。
  </div>

  <div class="page-grid page-grid--two report-assistant-page__layout">
    <section class="surface-panel page-panel report-assistant-page__form">
      <header class="page-section__header">
        <h2 class="page-section__title">解析に送る内容を整理する</h2>
        <p class="page-section__subtitle">
          重要な出来事ごとにセクションを分けると、タスクや提案の精度が高まります。
        </p>
      </header>

      <form class="page-form" [formGroup]="form" (submit)="submit($event)" novalidate>
        <div class="form-grid form-grid--two">
          <div class="form-field form-field--full">
            <label class="form-field__label" for="tags">タグ</label>
            <input
              id="tags"
              type="text"
              class="form-control"
              formControlName="tags"
              placeholder="例: backend, 障害対応"
            />
            <p class="form-note">カンマまたはスペース区切りで入力すると複数タグを追加できます。</p>
          </div>
        </div>

        <div class="form-collection report-assistant-page__sections" formArrayName="sections">
          <header class="page-section__header">
            <h3 class="page-section__title">日報・週報セクション</h3>
            <p class="page-section__subtitle">
              セクション内の本文は必須です。見出しを付けると、カードのタイトルに反映されます。
            </p>
          </header>

          @for (section of sections.controls; track section; let index = $index) {
            <div class="form-collection__item" [formGroupName]="index">
              <div class="form-collection__header">
                <h4 class="form-collection__title">セクション {{ index + 1 }}</h4>
                <button
                  type="button"
                  class="button button--ghost button--pill focus-ring"
                  (click)="removeSection(index)"
                  [disabled]="sections.length === 1"
                >
                  削除
                </button>
              </div>

              <div class="form-grid form-grid--two report-assistant-page__section-grid">
                <div class="form-field">
                  <label class="form-field__label">タイトル</label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="title"
                    placeholder="例: 対応内容"
                  />
                </div>

                <div class="form-field form-field--full">
                  <label class="form-field__label"> 本文 <span aria-hidden="true">*</span> </label>
                  <textarea
                    class="form-control form-control--textarea"
                    formControlName="body"
                    rows="4"
                    placeholder="重要な出来事や気づきを入力してください"
                  ></textarea>
                </div>
              </div>
            </div>
          }

          <button type="button" class="button button--secondary focus-ring" (click)="addSection()">
            セクションを追加
          </button>
        </div>

        <div class="form-actions">
          <button type="submit" class="button button--primary focus-ring" [disabled]="pending()">
            <shared-ai-mark />
            解析を実行
          </button>
        </div>

        @if (error(); as errorMessage) {
          <div class="app-alert app-alert--error" role="alert">
            {{ errorMessage }}
          </div>
        }
        @if (successMessage(); as successMessage) {
          <div class="app-alert app-alert--success" role="status">
            {{ successMessage }}
          </div>
        }
      </form>
    </section>

    <aside class="report-assistant-page__insights">
      @if (detail(); as active) {
        <section class="surface-panel page-panel report-assistant-page__results">
          <header class="page-section__header">
            <h2 class="page-section__title">解析結果</h2>
            <p class="page-section__subtitle">
              AI が抽出したタスク案とイベント履歴を確認し、必要に応じてボードへ追加してください。
            </p>
          </header>

          <div class="report-assistant-page__status-group">
            <span class="page-badge page-badge--accent">ステータス {{ active.status }}</span>
            <span class="page-badge">提案 {{ proposalControls.length }} 件</span>
          </div>

          @if (active.failure_reason) {
            <div class="app-alert app-alert--error" role="alert">
              失敗理由: {{ active.failure_reason }}
            </div>
          }

          @if (hasProcessingWarnings()) {
            <div class="app-alert app-alert--notice" role="status">
              @for (warning of processingWarnings(); track warning) {
                <p>{{ warning }}</p>
              }
            </div>
          }

          <section class="report-assistant-page__group">
            <header class="report-assistant-page__group-header">
              <h3 class="page-section__title">日報・週報本文</h3>
            </header>
            <ul class="page-list" aria-label="送信した日報の内容">
              @for (section of active.sections; track section; let index = $index) {
                <li class="page-list__item">
                  <div class="page-list__heading">
                    <p class="page-list__title">
                      {{ section.title || 'セクション ' + (index + 1) }}
                    </p>
                  </div>
                  <p class="page-list__description">{{ section.body }}</p>
                </li>
              }
            </ul>
          </section>

          @if (active.cards.length > 0) {
            <section class="report-assistant-page__group">
              <header class="report-assistant-page__group-header">
                <h3 class="page-section__title">生成されたタスク</h3>
              </header>
              <ul class="page-list" aria-label="生成されたタスク">
                @for (card of active.cards; track card) {
                  <li class="page-list__item">
                    <div class="page-list__heading">
                      <p class="page-list__title">{{ card.title }}</p>
                      <span class="page-badge page-badge--accent">
                        優先度 {{ card.priority || 'medium' }}
                      </span>
                    </div>
                    <p class="page-list__description">{{ card.summary }}</p>
                    @if (card.subtasks.length > 0) {
                      <div class="report-assistant-page__subtasks">
                        @for (subtask of card.subtasks; track subtask) {
                          <span class="surface-pill px-3 py-1">
                            {{ subtask.title }}
                          </span>
                        }
                      </div>
                    }
                  </li>
                }
              </ul>
            </section>
          }

          <section class="report-assistant-page__group">
            <header
              class="report-assistant-page__group-header report-assistant-page__group-header--with-action"
            >
              <div>
                <h3 class="page-section__title">提案中のタスク</h3>
                <p class="page-section__subtitle">
                  必要な提案を個別にカードとして起票できます。内容を編集したり、提案を追加・削除したりできます。
                </p>
              </div>
              <button
                type="button"
                class="button button--secondary focus-ring"
                (click)="addProposal()"
              >
                提案を追加
              </button>
            </header>

            @if (publishSuccess(); as successMessage) {
              <div class="app-alert app-alert--success" role="status">
                {{ successMessage }}
              </div>
            }
            @if (publishError(); as errorMessage) {
              <div class="app-alert app-alert--error" role="alert">
                {{ errorMessage }}
              </div>
            }

            @if (proposalControls.length > 0) {
              <ul class="page-list page-list--stacked" aria-label="提案中のタスク">
                @for (proposal of proposalControls; track proposal; let index = $index) {
                  <li class="page-list__item">
                    <div class="report-assistant-page__proposal-editor" [formGroup]="proposal">
                      <div class="report-assistant-page__proposal-header">
                        <div class="form-field form-field--full">
                          <label class="form-field__label">
                            タイトル <span aria-hidden="true">*</span>
                          </label>
                          <input
                            type="text"
                            class="form-control"
                            formControlName="title"
                            placeholder="提案するタスクのタイトルを入力"
                          />
                        </div>
                        <div class="report-assistant-page__proposal-actions">
                          <button
                            type="button"
                            class="button button--secondary focus-ring"
                            (click)="publishProposal(index)"
                            [disabled]="publishPending() || proposal.invalid"
                          >
                            この提案をカードに追加
                          </button>
                          <button
                            type="button"
                            class="button button--ghost focus-ring"
                            (click)="removeProposal(index)"
                          >
                            提案を削除
                          </button>
                        </div>
                      </div>

                      <div class="form-field form-field--full">
                        <label class="form-field__label">
                          概要 <span aria-hidden="true">*</span>
                        </label>
                        <textarea
                          class="form-control form-control--textarea"
                          formControlName="summary"
                          rows="3"
                          placeholder="提案の背景や詳細を入力"
                        ></textarea>
                      </div>

                      <div class="form-grid form-grid--two report-assistant-page__proposal-grid">
                        <div class="form-field">
                          <label class="form-field__label">推奨ステータス</label>
                          <shared-ui-select
                            formControlName="status"
                            [options]="statusSelectOptions()"
                          />
                        </div>
                        <div class="form-field">
                          <label class="form-field__label">推奨ラベル</label>
                          <input
                            type="text"
                            class="form-control"
                            formControlName="labels"
                            placeholder="カンマまたはスペース区切りで入力"
                          />
                          <p class="form-note">例: backend, リリース準備</p>
                        </div>
                        <div class="form-field">
                          <label class="form-field__label">優先度</label>
                          <shared-ui-select
                            formControlName="priority"
                            [options]="priorityOptions"
                          />
                        </div>
                        <div class="form-field">
                          <label class="form-field__label">期限目安 (日)</label>
                          <input
                            type="number"
                            class="form-control"
                            formControlName="dueInDays"
                            min="0"
                            placeholder="例: 3"
                          />
                        </div>
                      </div>

                      <div class="report-assistant-page__subtasks-editor" formArrayName="subtasks">
                        <header class="report-assistant-page__subtasks-header">
                          <h4 class="page-section__title">サブタスク</h4>
                          <button
                            type="button"
                            class="button button--ghost focus-ring"
                            (click)="addSubtask(index)"
                          >
                            サブタスクを追加
                          </button>
                        </header>

                        @if (proposalSubtasks(index).length > 0) {
                          @for (
                            subtask of proposalSubtasks(index).controls;
                            track subtask;
                            let subIndex = $index
                          ) {
                            <div
                              class="report-assistant-page__subtask-editor"
                              [formGroupName]="subIndex"
                            >
                              <div class="form-grid form-grid--two">
                                <div class="form-field">
                                  <label class="form-field__label">タイトル</label>
                                  <input
                                    type="text"
                                    class="form-control"
                                    formControlName="title"
                                    placeholder="例: 調査"
                                  />
                                </div>
                                <div class="form-field">
                                  <label class="form-field__label">ステータス</label>
                                  <input
                                    type="text"
                                    class="form-control"
                                    formControlName="status"
                                    placeholder="todo / in-progress / done"
                                  />
                                </div>
                                <div class="form-field form-field--full">
                                  <label class="form-field__label">詳細</label>
                                  <textarea
                                    class="form-control form-control--textarea"
                                    formControlName="description"
                                    rows="2"
                                    placeholder="補足情報を入力"
                                  ></textarea>
                                </div>
                              </div>
                              <div class="report-assistant-page__subtask-actions">
                                <button
                                  type="button"
                                  class="button button--ghost focus-ring"
                                  (click)="removeSubtask(index, subIndex)"
                                >
                                  サブタスクを削除
                                </button>
                              </div>
                            </div>
                          }
                        } @else {
                          <p class="form-note">
                            サブタスクはまだありません。必要に応じて「サブタスクを追加」をクリックしてください。
                          </p>
                        }
                      </div>
                    </div>
                  </li>
                }
              </ul>
            } @else {
              <p class="form-note">
                提案がありません。手動で提案を追加してカード化することもできます。
              </p>
            }
          </section>

          <section class="report-assistant-page__group">
            <header class="report-assistant-page__group-header">
              <h3 class="page-section__title">イベント履歴</h3>
            </header>
            <ul class="page-list" aria-label="イベント履歴">
              @for (event of active.events; track event) {
                <li class="page-list__item">
                  <div class="page-list__heading">
                    <p class="page-list__title">{{ event.event_type }}</p>
                  </div>
                  <div class="page-list__meta">
                    <span>{{ event.created_at | localDateTime: 'short' }}</span>
                  </div>
                </li>
              }
            </ul>
          </section>
        </section>
      } @else {
        <section class="surface-panel page-panel report-assistant-page__results">
          <header class="page-section__header">
            <h2 class="page-section__title">解析結果</h2>
            <p class="page-section__subtitle">
              日報を送信すると、ここにカード案やイベントが表示されます。
            </p>
          </header>
          <div class="page-state" role="status">
            <h2>まだ解析結果がありません</h2>
            <p>フォームに日報を入力して AI 解析を実行すると、ここに提案が表示されます。</p>
            <p>解析後に本文は破棄されるため、履歴として保存されません。</p>
          </div>
        </section>
      }
    </aside>
  </div>
</shared-page-layout>
