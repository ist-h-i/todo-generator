name: Auto Resolve Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/workflows/**'

concurrency:
  group: auto-resolve-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  auto-resolve:
    if: ${{ !github.event.pull_request.draft && !github.event.pull_request.head.repo.fork }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    env:
      GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Merge base branch into PR
        run: |
          git fetch origin ${{ github.base_ref }}
          git merge --no-commit --no-ff origin/${{ github.base_ref }} || true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            package-lock.json
            frontend/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            backend/requirements.txt

      - name: Set up Chrome (only if frontend exists)
        if: ${{ hashFiles('frontend/package.json') != '' || hashFiles('package.json') != '' }}
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install MCP servers
        run: |
          npm install -g @modelcontextprotocol/server-filesystem
          python -m pip install --upgrade pip
          pip install mcp-server-git

      - name: Install Codex deps (Gemini)
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai pytest

      - name: Run Codex auto-resolve
        run: |
          if [ -z "${GEMINI_API_KEY:-${GOOGLE_API_KEY:-}}" ]; then
            echo "GEMINI_API_KEY/GOOGLE_API_KEY not set. Skipping auto-resolve."
            exit 0
          fi
          python scripts/auto_resolve_conflicts.py

      - name: Run Tests
        env:
          CHROME_BIN: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          set -e
          ran_tests=false

          if [ -f frontend/package.json ]; then
            ran_tests=true
            pushd frontend > /dev/null
            npm ci
            if [ -f karma.conf.cjs ] || [ -f karma.conf.js ]; then
              npx ng test --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage || (echo "Retry once..." && npx ng test --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage)
            else
              echo "No Karma config. Skipping frontend unit tests."
            fi
            popd > /dev/null
          elif [ -f package.json ] && grep -q "\"@angular/" package.json 2>/dev/null; then
            ran_tests=true
            npm ci
            npx ng test --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage || (echo "Retry once..." && npx ng test --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage)
          fi

          if [ -f backend/requirements.txt ]; then
            ran_tests=true
            pip install -r backend/requirements.txt
            pushd backend > /dev/null
            pytest || (echo "Retry once..." && pytest)
            popd > /dev/null
          elif [ -f requirements.txt ]; then
            ran_tests=true
            pip install -r requirements.txt
            pytest || (echo "Retry once..." && pytest)
          fi

          if [ "$ran_tests" = false ]; then
            echo "No test framework detected. Skipping."
          fi

      - name: Upload test reports (best-effort)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            frontend/coverage/**
            coverage.xml
            backend/coverage.xml
          retention-days: 7
          if-no-files-found: ignore

      - name: Commit & Push if tests pass
        if: success()
        run: |
          git config --global user.name "merge-bot"
          git config --global user.email "merge-bot@example.com"
          git add .
          git commit -m "[skip ci] ðŸ¤– auto-resolved merge conflicts (tests passed)" || echo "No changes to commit"
          git push --force-with-lease origin HEAD:${{ github.head_ref }}
