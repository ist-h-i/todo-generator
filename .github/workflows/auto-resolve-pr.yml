# .github/workflows/auto-resolve-pr.yml
name: Auto Resolve Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/workflows/**'

concurrency:
  group: auto-resolve-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  auto-resolve:
    if: ${{ !github.event.pull_request.draft && !github.event.pull_request.head.repo.fork }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Merge base branch into PR (no commit yet)
        run: |
          git fetch origin ${{ github.base_ref }}
          git merge --no-commit --no-ff origin/${{ github.base_ref }} || true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            package-lock.json
            frontend/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            backend/requirements.txt

      - name: Set up Chrome only when Karma runs
        if: ${{ hashFiles('frontend/karma.conf.*','karma.conf.*') != '' }}
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install MCP servers
        run: |
          npm i -g @modelcontextprotocol/server-filesystem
          python -m pip install --upgrade pip
          python -m pip install mcp-server-git || true

      - name: Install Codex deps (OpenAI)
        run: |
          python -m pip install --upgrade pip
          pip install "openai>=1.40.0" pytest pytest-cov

      - name: Run Codex auto-resolve
        run: |
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "OPENAI_API_KEY not set. Skipping auto-resolve."
            exit 0
          fi
          python scripts/auto_resolve_conflicts.py

      - name: Run Tests
        env:
          CHROME_BIN: ${{ steps.setup-chrome.outputs.chrome-path }}
          CI: true
        run: |
          set -e
          ran_tests=false

          if [ -f frontend/package.json ]; then
            ran_tests=true
            pushd frontend >/dev/null
            npm ci
            if [ -f karma.conf.cjs ] || [ -f karma.conf.js ] || [ -f karma.conf.mjs ]; then
              if grep -q "ChromeHeadlessNoSandbox" karma.conf.* 2>/dev/null; then
                npx ng test --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage \
                || (echo "Retry once..." && npx ng test --watch=false --browsers=ChromeHeadlessNoSandbox --code-coverage)
              else
                npx ng test --watch=false --browsers=ChromeHeadless --code-coverage \
                || (echo "Retry once..." && npx ng test --watch=false --browsers=ChromeHeadless --code-coverage)
              fi
            else
              echo "No Karma config. Skipping frontend unit tests."
            fi
            popd >/dev/null
          elif [ -f package.json ] && grep -q "\"@angular/" package.json 2>/dev/null; then
            ran_tests=true
            npm ci
            npx ng test --watch=false --browsers=ChromeHeadless --code-coverage \
            || (echo "Retry once..." && npx ng test --watch=false --browsers=ChromeHeadless --code-coverage)
          fi

          if [ -f backend/requirements.txt ]; then
            ran_tests=true
            pip install -r backend/requirements.txt
            pushd backend >/dev/null
            pytest -q --maxfail=1 --disable-warnings --cov=. --cov-report=xml:coverage.xml \
            || (echo "Retry once..." && pytest -q --maxfail=1 --disable-warnings --cov=. --cov-report=xml:coverage.xml)
            popd >/dev/null
          elif [ -f requirements.txt ]; then
            ran_tests=true
            pip install -r requirements.txt
            pytest -q --maxfail=1 --disable-warnings --cov=. --cov-report=xml:coverage.xml \
            || (echo "Retry once..." && pytest -q --maxfail=1 --disable-warnings --cov=. --cov-report=xml:coverage.xml)
          fi

          if [ "$ran_tests" = false ]; then
            echo "No test framework detected. Skipping."
          fi

      - name: Upload test reports (best-effort)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            frontend/coverage/**
            backend/coverage.xml
            coverage.xml
          retention-days: 7
          if-no-files-found: ignore

      - name: Commit & Push if tests pass
        if: success()
        run: |
          git config --global user.name "merge-bot"
          git config --global user.email "merge-bot@example.com"
          git add -A
          if git rev-parse -q --verify MERGE_HEAD >/dev/null; then
            git commit -m "ğŸ¤– auto-resolved merge (tests passed)"
          else
            git commit -m "[skip ci] ğŸ¤– auto-resolved changes (tests passed)" || echo "No changes to commit"
          fi
          git push origin HEAD:${{ github.head_ref }}
