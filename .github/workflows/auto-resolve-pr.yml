# .github/workflows/auto-resolve-pr.yml
name: Auto Resolve Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - '.github/workflows/**'

concurrency:
  group: auto-resolve-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  auto-resolve:
    if: ${{ !github.event.pull_request.draft && !github.event.pull_request.head.repo.fork }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Merge base branch into PR (no commit yet)
        run: |
          git fetch origin ${{ github.base_ref }}
          git merge --no-commit --no-ff origin/${{ github.base_ref }} || true

      - name: Set up Node.js (with cache)
        if: ${{ hashFiles('frontend/package-lock.json','frontend/npm-shrinkwrap.json','frontend/yarn.lock') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json

      - name: Set up Node.js (no cache)
        if: ${{ hashFiles('frontend/package-lock.json','frontend/npm-shrinkwrap.json','frontend/yarn.lock') == '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install root deps
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm i; fi

      - name: Install frontend deps
        if: ${{ hashFiles('frontend/package.json') != '' }}
        run: |
          pushd frontend >/dev/null
          if [ -f package-lock.json ]; then npm ci; else npm i; fi
          popd >/dev/null

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            backend/requirements.txt

      - name: Set up Chrome only when Karma runs
        if: ${{ hashFiles('frontend/karma.conf.*','karma.conf.*') != '' }}
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install Codex CLI
        run: |
          npm i -g @openai/codex@0.39.0
          codex --version

      - name: Restore ChatGPT auth (no API key)
        env:
          CODEX_AUTH_JSON_B64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
        run: |
          set -euo pipefail
          test -n "${CODEX_AUTH_JSON_B64:-}" || { echo "::error::Missing secret CODEX_AUTH_JSON_B64"; exit 1; }
          mkdir -p "$HOME/.codex"
          echo "$CODEX_AUTH_JSON_B64" | base64 -d > "$HOME/.codex/auth.json"
          chmod 600 "$HOME/.codex/auth.json"
          printf 'preferred_auth_method = "chatgpt"\n' > "$HOME/.codex/config.toml"

      - name: Auto-resolve conflicts via Codex
        run: |
          set -euo pipefail
          # 衝突が無ければ早期終了
          if ! git diff --name-only --diff-filter=U | grep . >/dev/null; then
            echo "No conflicts."
            exit 0
          fi
          # 指示をCodexに渡してワークツリーを書き換え＆ステージ
          codex exec --quiet --sandbox workspace-write <<'TXT'
          Resolve all Git merge conflicts currently present in the repository.
          Rules:
          - Edit files in-place. Remove all conflict markers (<<<<<<<, =======, >>>>>>>).
          - Preserve surrounding context and project conventions.
          - Run any minimal steps needed to ensure syntax/types build.
          - After editing, stage updated files: `git add <files>`.
          - Do NOT commit.
          Return a short summary of touched files.
          TXT

                - name: Verify conflicts are resolved
                  run: |
                    if git diff --name-only --diff-filter=U | grep .; then
                      echo "::error::Unresolved conflicts remain."
                      exit 1
                    fi

      - name: Commit & Push if tests pass
        if: success()
        run: |
          git config --global user.name "merge-bot"
          git config --global user.email "merge-bot@example.com"
          git add -A
          if git rev-parse -q --verify MERGE_HEAD >/dev/null; then
            git commit -m "🤖 auto-resolved merge (tests passed)"
          else
            git commit -m "[skip ci] 🤖 auto-resolved changes (tests passed)" || echo "No changes to commit"
          fi
          git push origin HEAD:${{ github.head_ref }}
