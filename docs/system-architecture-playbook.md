# System Architecture Playbook

このドキュメントは Todo Generator アプリケーションの構造と運用ルールを体系化し、類似プロダクト開発時のベースラインとして再利用できるようにまとめたものです。アプリ固有の実装に根ざしつつも、汎用化しやすい原則とベストプラクティスを併記しています。

## 1. アーキテクチャ概要

- **全体構成**: Angular SPA と FastAPI バックエンドが REST/JSON で通信し、SQLAlchemy 経由で RDB (SQLite/PostgreSQL) を操作します。Gemini API を経由した AI 連携や管理 UI を備え、SPA 側が主導してユーザー操作を行います。
- **非機能要件の優先順位**: 
  1. セキュリティ (権限制御・秘密情報の暗号化)
  2. 一貫性のある UX (楽観的 UI + 冪等な API)
  3. 拡張性 (新規 AI 機能や管理機能の追加を許容)
  4. オブザーバビリティ (イベントログやトークン使用量の記録)
- **境界づけられたコンテキスト**: ワークスペース運用、分析・改善、レポート自動化、コンピテンシー評価、管理者向け運用という 5 つのコンテキストに分割。フロントとバック双方で同じ境界が意識されています。
- **通信パターン**: SPA からは `core/api/*` サービスを通して純粋な REST 呼び出しを行い、バックエンドは Pydantic スキーマを利用して strict な入出力検証を実施します。

## 2. クラス構成と責務分担

### フロントエンド (Angular)

- **エントリポイント**: `app.routes.ts` で Lazy Load を徹底し、ガード (`authGuard`, `adminGuard`) をルーティングレベルで宣言することで、初期ロードを抑えつつ権限制御を保証します。
- **状態管理**: Angular Signals ベースのストア (`core/state/*`) がワークスペースや分析データを保持。各ストアは以下の役割を持ちます。
  - `WorkspaceStore`: カード・サブタスク・コメント・設定などボード表示に必要なデータのキャッシュと同期。
  - `ContinuousImprovementStore`: 分析スナップショット、イニシアチブ、AI 提案を正規化し、レポートやダッシュボードへ供給。
- **サービス層**: `core/api/*` が HTTP クライアントを抽象化し、ログ記録・認証ヘッダー設定・リトライ方針を統一します。`lib/forms/*` などのヘルパーは UI とロジックの結合度を下げるためのユーティリティとして位置づけます。
- **UI コンポーネント**: 機能単位の `features/*` 配下にページ／コンテナを配置し、共有コンポーネントは `shared/ui` に集約。テンプレートはシンプルに保ち、ロジックは TypeScript 側へ寄せます。

### バックエンド (FastAPI)

- **エントリポイント**: `app.main` が環境設定・CORS・ルータ登録・起動時マイグレーションを実行。依存関係の定義は FastAPI の `Depends` を利用し明示的に宣言します。
- **ルータ構成**: コンテキストごとに `app/routers/*` を分離。例: `analysis.py`, `reports.py`, `admin_settings.py`。ルータはバリデーションとサービス呼び出しに集中させ、副作用はサービス層へ委譲します。
- **サービス層**: `app/services/*` では Gemin i連携やレポート処理などのドメインロジックを担当。副作用 (DB 書き込み・外部 API 呼び出し) を囲い込むことでユニットテストやモックが容易になります。
- **モデル層**: `app/models.py` に SQLAlchemy モデルを集中させ、UUID 主キー、タイムスタンプ mixin、関連テーブルを明示。Pydantic スキーマは `app/schemas/*` で API 入出力専用として管理します。
- **ユーティリティ**: 共通関心事 (暗号化、クオータ管理、リポジトリ補助) は `app/utils/*` に集約し、再利用性とテスト容易性を高めます。

## 3. 設計思想

1. **ドメイン駆動設計の実践**: 境界づけられたコンテキスト単位でモデル・サービス・ルータを整理し、ユースケースの追加が既存コードの最小変更で済むようにします。
2. **API ファースト**: Pydantic スキーマと OpenAPI ドキュメントを真実のソースとして扱い、フロントとバック双方が同じ契約を共有します。変更時は必ずスキーマから着手して互換性を評価します。
3. **明示的な副作用管理**: 外部サービス (Gemini、メール、暗号化) への依存をサービス層に封じ込め、テストではスタブを注入できるようにします。
4. **セキュリティをデフォルトに**: 依存解決時に権限と秘密鍵の存在を検証し、トークンは保存前にハッシュ化。UI でも Guard とロールベース表示制御を採用します。
5. **オブザーバビリティの確保**: レポートイベントやトークン使用量、AI 提案の採択履歴を蓄積し、改善サイクルの根拠データとして活用できるようにします。

## 4. コーディングルール

### 共通原則

- `.editorconfig` を遵守し、UTF-8、末尾改行、空白トリムを徹底します。
- ドキュメント化された命名規則 (Python は snake_case、TypeScript は camelCase/kebab-case、Pydantic モデルは PascalCase) を守ります。
- プルリクエストは「何を・なぜ」を説明するサマリを必ず記載し、UI 変更はスクリーンショットを添付します。

### Python (FastAPI)

- Black (120 列) と Ruff を標準整形・Lint とし、import 順序や未使用コードを自動修正します。
- 例外は明示的にハンドリングし、ステータスコードとエラー本文を統一。ログには個人情報を含めないよう配慮します。
- 型ヒントと `Annotated` 依存を活用して IDE サポートを最大化。Pydantic v2 の `model_config` を活用しシリアライズ/デシリアライズを最適化します。

### TypeScript (Angular)

- ESLint + Prettier をベースに single quote, trailing comma, arrow-parens 一貫性を維持します。
- コンポーネントは `OnPush` 変化検出をデフォルトとし、Signals や RxJS の購読解除を忘れないようにします。
- API 呼び出しは Service 層を介し、コンポーネントから直接 `HttpClient` を叩かない。レスポンス型は `@api-types` などの共有型を import して再利用します。

## 5. デザイン方針

- **情報アーキテクチャ**: ダッシュボード型 UX のため、優先指標と操作をファーストビューに配置。サイドパネル (drawers) とモーダルで詳細情報を段階的に提示します。
- **ビジュアルデザイン**: Tailwind ライクなデザイントークン (`frontend/src/styles/pages`) とフィーチャー毎の SCSS を組み合わせて UI の一貫性を保ちます。配色はコントラスト比 4.5:1 以上を基準とし、ホバー／フォーカス状態を明示します。
- **インタラクション**: ドラッグ＆ドロップなどの重操作は楽観的更新 + トーストでフィードバック。API 失敗時は自動リトライとユーザー通知をセットにします。
- **アクセシビリティ**: ARIA 属性、キーボードフォーカスリング、スクリーンリーダー対応テキストをコンポーネントレベルで実装し、E2E テストで検証します。
- **国際化**: 文言は i18n リソースへ集約し、デフォルト言語が変わるケースでも UI コードの変更が最小になるようにします。

## 6. 品質保証ワークフロー

- **テスト戦略**: バックエンドは `pytest backend/tests` を基本とし、サービス層のスタブ化でユニットテストと統合テストを両立。フロントは `npm test -- --watchAll=false` で UI レイヤーを検証します。
- **静的解析**: `ruff check` と `npm run lint` を必須実行。ドキュメントのみの変更時は `docs/development-rules.md` に従いスキップ可とします。
- **ビルド検証**: Angular は `npm run build` を通して型チェックと AOT ビルドが成功することを確認します。
- **セルフレビュー**: 変更差分をセルフレビューし、仕様に沿っているか、不要なデバッグコードが残っていないかを確認します。重要な設計判断はドキュメントへ追記して共有します。

## 7. 運用とセキュリティ

- **シークレット管理**: `utils.secrets` を利用し AES-GCM で暗号化。キーは環境変数 `SECRET_ENCRYPTION_KEY` によって差し替えます。
- **権限制御**: `require_admin` ディペンデンシをルータで利用し、SPA 側もガードとロールベース描画を実装。バックエンドでの検証を優先します。
- **監査ログ**: ステータスレポート、AI 提案採択、クオータ変更など重要操作は `StatusReportEvent` など専用テーブルに履歴を残し、問い合わせ対応と分析に備えます。
- **クオータ enforcement**: `utils.quotas` が全体・個別クオータを統合し、API レートを制御。AI やカード作成で乱用が起きないよう、使用量テーブルで残量を管理します。

## 8. ドキュメントとナレッジシェア

- `docs/` 配下にあるアーキテクチャ、データフロー、機能仕様ドキュメントを常に最新に保ちます。新しいユースケースが追加された場合は、本プレイブックも更新して抽象化された学びを反映させてください。
- UI 変更時は `ui-design-system.md` と `ui-layout-requirements.md` を参照し、差分があれば追記します。スクリーンショットは PR や設計レビューの必須添付物です。
- 仕様・設計の議論は issue テンプレートに沿って記録し、意思決定ログを残すことでオンボーディングを容易にします。

---

本プレイブックは Todo Generator の実装に裏打ちされたベストプラクティスをまとめたものです。新規アプリケーションに転用する際は、ドメイン特性に応じて境界づけやガバナンス要件を調整しつつ、ここで挙げた原則とワークフローを出発点にしてください。
