# 開発時のルール

開発を円滑に進め、品質を担保するために、以下のルールを必ず遵守してください。  

---

## 推奨開発フロー

1. **最新の `main` ブランチを取り込んで作業ブランチを準備する**  
   - 作業開始前や途中で `git pull origin main` を実行し、差分を早めに解消する。  

2. **実装とセルフレビューを進める**  
   - 仕様やチケット条件を確認しながら小さなコミットを積み上げる。  
   - レビュー前に差分を読み直し、セルフチェックを行う。  

3. **品質チェックを実行する**  
   - **実際に修正を加えた領域のみ対象**とし、必要なケースだけテスト・チェックを走らせる。  
   - 実行対象は以下のとおり。  
    - バックエンド: `pytest backend/tests`
    - フロントエンド: `cd frontend && npm test`
      - Karma は環境変数 `CHROME_BIN=/usr/bin/chromium-browser` に設定された Chromium を利用する。
     - コードフォーマット: `black --check`（変更ファイルのみを対象とする）  
     - 静的解析: `ruff check`（変更ファイルのみを対象とする）  
     - フロントエンドフォーマット: `cd frontend && npm run format:check`（変更ファイルのみを対象とする）  
     - ビルド: `cd frontend && npm run build`  
   - コメントやドキュメント修正のみの場合は **テスト・フォーマット・ビルドをスキップ可能**。ただし、コードへ影響の可能性があれば実行する。  
   - いずれかが失敗した場合は修正し、**再度全ての必要チェックを通過するまで繰り返す**。  

4. **ドキュメントを最新化する**  
   - `README.md` や `docs/` 配下の仕様・ルールを更新する。  
   - ドキュメントの矛盾を残さないよう確認する。  

5. **UI 変更時のスクリーンショット取得**  
   - `cd frontend && npm start` でプレビューを確認し、スクリーンショットを取得。  
   - マージリクエストに添付し、必要に応じて注釈を追加する。  

6. **タスク完了前に最新の `main` を取り込む**  
   - `git fetch origin main && git merge origin/main`（またはリベース手順）を実行。  
   - コンフリクトが発生した場合は解消後、再度必要なビルド・テストを行う。  

---

## マージ前の必須ルール

1. **修正の種類に応じたチェックの完了**  
   - **コード修正がある場合** → 上記の必要な品質チェックをすべて通過していること。  
   - **コメント／ドキュメント修正のみの場合** → 品質チェックは不要。内容の妥当性を確認すること。  

2. **最新の `main` を取り込むこと**  
   - コンフリクトが発生した場合は必ず解消する。  
   - 解消後は必要に応じて再ビルド・再テストを実行する。  

3. **コンフリクト修正ルール**  
   - 未解消の状態ではマージ不可。  
   - 修正後は動作確認を行い、チェックが必要な場合は再実行する。  

4. **UI 変更時の対応**  
   - 画面サイズや状態ごとのスクリーンショットを網羅する。  
   - 新旧比較が可能な場合は並べて提示し、確認者が差分を把握しやすくする。  

```json
{
  "development_rules": {
    "workflow": [
      "作業開始前や途中で最新の main を取り込み、差分を早めに解消する。",
      "仕様を確認しながら小さなコミットを積み重ね、セルフレビューを行う。",
      "レビュー依頼前に差分を読み直しセルフチェックを行う。"
    ],
    "quality_checks": {
      "normal_changes": {
        "backend_tests": "pytest backend/tests",
        "frontend_tests": "cd frontend && npm test",
        "formatting": [
          "black --check （変更ファイルのみ）",
          "cd frontend && npm run format:check （変更ファイルのみ）"
        ],
        "lint": "ruff check （変更ファイルのみ）",
        "build": "cd frontend && npm run build",
        "rules": [
          "対象領域に応じて必要なケースのみ実行する。",
          "失敗した場合は修正後、全て通過するまで再実行する。"
        ]
      },
      "doc_or_comment_changes": {
        "skip_checks": true,
        "rules": [
          "コメントやドキュメント修正のみの場合はテスト・フォーマット・ビルドをスキップ可能。",
          "ただしコードに影響の可能性がある場合は通常チェックを実行する。"
        ]
      }
    },
    "documentation_and_ui": [
      "README.md や docs/ 配下を最新仕様に更新する。",
      "UI に変更がある場合はプレビューで確認しスクリーンショットを取得、マージリクエストに添付する。",
      "画面バリエーションがある場合は網羅的にキャプチャし、新旧比較も提示する。"
    ],
    "pre_merge_requirements": {
      "normal_changes": [
        "コード修正がある場合は全ての必要チェックを通過していること。"
      ],
      "doc_or_comment_changes": [
        "コメントやドキュメント修正のみの場合は品質チェック不要。内容確認に集中すること。"
      ],
      "common": [
        "最新の main を取り込み、コンフリクトがあれば解消すること。",
        "解消後は必要に応じて再ビルド・再テストを行うこと。",
        "UI 変更がある場合はスクリーンショットを必ず掲載すること。"
      ]
    }
  }
}
```
