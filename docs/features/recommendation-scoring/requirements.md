# 推薦スコア算出 要件定義書

## ドキュメント管理
| 項目 | 内容 |
| --- | --- |
| バージョン | 1.2 |
| 作成者 | プロダクトデザインチーム |
| 最終更新日 | 2024-08-30 |
| ステータス | In Review |

## 1. 目的と背景
- 起票されたカードごとに「おすすめ度」スコアを自動付与し、ファシリテータが採択判断を素早く行えるようにする。
- スコアはカード本文（タイトル・サマリ・詳細）とボードに設定されたラベルとの相関、ならびに起票ユーザのプロフィールとの一致度を考慮した総合値とする。
- 本番環境のAI推論結果と同等の契約をローカル／テスト環境で再現するため、バックエンドは軽量なトークン類似度ベースのロジックでサーバ側のみでスコアを算出し、クライアントからの値を受け付けない。

## 2. 利用者ペルソナ
| ペルソナ | ゴール | ニーズ |
| --- | --- | --- |
| スプリントファシリテータ | レトロスペクティブで大量に生成された提案から有効なアクションを素早く選定したい | 信頼できるおすすめ度スコアと、その背景要因が把握できるメタデータ |
| チームマネージャ | チームメンバーの職務範囲に沿ったタスクが割り当てられていることを確認したい | ユーザプロフィールを考慮したスコアリングと異常時のアラート |
| データオペレーション担当 | AI推論の安定稼働と品質を監視したい | スコア算出過程のログとメトリクス、閾値調整の自由度 |

## 3. 成功指標
| 指標 | 目標値 | 計測方法 |
| --- | --- | --- |
| スコア参照率 | 80%以上のカード確認操作でおすすめ度が閲覧される | フロントエンドのアクティビティ計測で`ai_confidence`表示イベントを集計 |
| 採択精度 | おすすめ度70以上のカードの採択率が60%以上 | 採択イベントとスコア値のクロス集計を分析基盤へ送信 |
| 推論エラー率 | スコア算出の失敗割合が1%未満 | バックエンドの推論失敗ログを監視ダッシュボードで集計 |

## 4. ユースケースと受け入れ基準
1. **カード生成時の自動スコアリング** – カードが作成されるたびに`RecommendationScoringService`でおすすめ度が計算され、0〜100の整数として保存される。クライアントから送信された`ai_confidence`や`ai_notes`は無視され、サーバ側で必ず上書きされる。
2. **カード更新時の再計算** – タイトル・サマリ・詳細・ラベルのいずれかが更新された場合は再度スコアを計算し、変更内容に応じて`ai_confidence`および`ai_notes`を更新する。ラベルがすべて削除された場合はラベル相関サブスコアが0となり、説明文にラベル欠如の注意が記載されるが、プロフィール適合度によっては最終スコアが正の値になることがある。
3. **ラベル相関の反映** – ボードラベル名とカード本文のトークン類似度に基づくサブスコアを算出し、相関が高いほどスコアを押し上げる。ラベルが未設定または空文字の場合はサブスコア0とする。
4. **プロフィール適合度の反映** – ユーザプロフィール（役割、自己紹介、ニックネーム）から抽出したトークンとカード本文の類似度をサブスコアとして算出し、適合しているほどスコアを押し上げる。プロフィール情報が不足している場合は0とする。
5. **説明可能性の提供** – `ai_notes`にはラベル相関度・プロフィール適合度・最終スコアの要約を含め、ラベル未設定やプロフィール未設定時にはその旨を追記する。
6. **エラーフォールバック** – スコア計算で例外が発生した場合はスコア0、`ai_notes`にフォールバックメッセージ、`failure_reason="scoring_error"`を設定し、カード生成フローを継続する。

## 5. 機能要件
1. バックエンドはカード生成APIで`RecommendationScoringService.score_card`を呼び出し、戻り値の`score`と`explanation`をそれぞれ`ai_confidence`、`ai_notes`としてカードエンティティに保存する。
2. スコアリングの入力は必須項目としてタイトル、任意項目としてサマリ・詳細を統合した本文、カードに紐づくラベル名一覧、`build_user_profile`で生成したユーザプロフィール（役割リスト、自己紹介、ニックネーム）とする。
3. ラベル相関サブスコアはカード本文と各ラベル名をトークン化してコサイン類似度を算出し、最高類似度を0〜100の小数（小数点以下2桁）として返す。ラベル側に有効なトークンがなければ0とする。
4. プロフィール適合サブスコアはプロフィールトークンとカード本文のコサイン類似度を0〜100の小数（小数点以下2桁）で返し、プロフィール情報が空の場合は0とする。
5. 最終スコアは`label_weight`と`profile_weight`による重み付き平均を0〜100にクランプして四捨五入した整数とする。ラベル相関が0でもプロフィール側が正の値であれば正の最終スコアとなる場合がある。両ウェイトが0の場合は`label_weight=1.0`、`profile_weight=0.0`として計算する。
6. ウェイトはデフォルトで相関0.6、適合0.4とし、`RECOMMENDATION_WEIGHT_LABEL`および`RECOMMENDATION_WEIGHT_PROFILE`環境変数で非負の値に設定できる。設定値が負の場合は初期化時にバリデーションエラーを発生させる。
7. 生成した`ai_notes`はラベル相関度・プロフィール適合度・最終スコアの要約を含め、データ欠如時の注意文を自動的に追記する。フロントエンドおよび外部クライアントは読み取り専用として扱い、更新リクエストでは無視される。
8. 例外発生時はスコア0、サブスコア0、`failure_reason="scoring_error"`、フォールバック説明文を返し、カード作成・更新処理を継続する。失敗はサーバログに記録される。

## 6. 非機能要件
- **性能**: スコアリング処理は1リクエストあたり150ms以内の追加レイテンシを目標とする。トークン化とコサイン類似度計算は同期処理で完結させる。
- **可用性**: 例外や設定値不備が発生してもカード生成フローは継続し、スコア0でフォールバックする。
- **監査性**: スコア計算が実施されたこと、フォールバックが発生した場合の理由をサーバログで追跡できるようにする。
- **セキュリティ**: プロフィール情報は必要最小限（役割、自己紹介、ニックネーム）のみに限定し、サーバ内でのみ使用する。保存済みプロフィールを再利用し、追加の機微情報を送信させない。

## 7. 依存関係と制約
- バックエンド設定で定義されたラベル・プロフィール重み値に依存する。運用チームは環境変数の設定ミスを防ぐための監視を行う。
- ボードラベルとユーザプロフィールの整備度合いがスコア精度に影響するため、マスター同期が前提。
- 将来的なフィードバックループ（採択実績からの重み調整）を見越し、データポイントを分析基盤へ連携する。
