# ユーザー登録・ユーザー種別・管理者ユーザー管理 要件定義

## Document Control

| 項目 | 内容 |
| --- | --- |
| Version | 0.1 |
| Author | Product / Engineering |
| Last Updated | 2025-12-29 |
| Status | Draft |

## 1. 背景・目的

本プロダクトは、AI 支援の業務ワークスペースとして複数ユーザーで利用される。利用開始時の「ユーザー新規登録」と、運用中の「ユーザー種別（権限）」「ユーザーの有効化・停止・削除」「日次上限（クォータ）の個別調整」を一貫したルールで提供し、セキュリティと運用容易性を両立する。

目的:

1. 利用者がセルフサービスでアカウントを作成できる。
2. 管理者が登録ユーザーを承認（有効化）し、最小権限で運用できる。
3. 管理者権限（管理者/一般）を明確化し、管理 API をサーバー側で確実に保護する。
4. 認証トークンを安全に扱い、漏えい時の影響を限定する（ハッシュ保管、期限、ローテーション）。

## 2. スコープ

### 2.1 対象（In Scope）

- ユーザー新規登録（セルフサインアップ）
- ログイン、セッション復元、ログアウト
- ユーザー種別（管理者/一般）とアカウント状態（有効/無効）
- 管理者によるユーザー一覧、権限変更、有効化/無効化、削除、クォータ個別設定

### 2.2 対象外（Out of Scope）

- パスワードリセット/再発行、メール認証、MFA/SSO
- 招待制のアカウント発行（招待メール送信など）
- 監査ログの高度化（管理操作の差分ログ、承認ワークフローの履歴化）
- 役割ベースアクセス制御（RBAC）の細分化（管理者以外の中間権限ロール）

## 3. 用語・前提

| 用語 | 説明 |
| --- | --- |
| ユーザー | 認証可能なアカウント単位（メールアドレスが識別子）。 |
| 管理者 | `is_admin=true` のユーザー。管理者専用 API および管理画面へのアクセス権を持つ。 |
| 一般ユーザー | `is_admin=false` のユーザー。通常機能のみ利用できる。 |
| 有効/無効 | `is_active=true/false`。無効ユーザーはログイン不可・既存トークンも無効扱い。 |
| 業務内容（roles） | プロフィール属性。アクセス制御ではなく、AI 推奨や分析の補助メタデータとして扱う。 |
| セッショントークン | `Authorization: Bearer <token>` で送信する認証トークン。DB にはハッシュ値を保存する。 |

## 4. ユーザー種別（権限モデル）

### 4.1 システム権限（グローバル）

1. **管理者**
   - 管理画面（`/admin`）へアクセスできる。
   - 管理 API（例: `/admin/users`）を利用できる。
2. **一般ユーザー**
   - 管理 API は利用できない（サーバー側で 403 を返す）。

### 4.2 アカウント状態

- **有効（Active）**
  - ログイン可能。
  - 既存セッションも有効（トークン期限内）。
- **無効（Inactive）**
  - ログイン不可（ログイン API は 403）。
  - 既存セッションも API 利用時に拒否される（`/auth/me` を含む）。

### 4.3 プロフィール属性（権限ではない）

- ニックネーム、経験年数、業務内容（roles）、自己紹介、アイコン画像はプロフィール情報であり、アクセス制御に利用しない。
- 「業務内容（roles）」は最大 10 件、各要素は 200 文字以内の文字列を想定する。

## 5. ユーザー新規登録（セルフサインアップ）要件

### 5.1 画面要件（フロントエンド）

- 入口はログイン画面（`/login`）の「新規登録」ビュー。
- 入力項目:
  - メールアドレス
  - ニックネーム
  - パスワード
  - 確認用パスワード
- 入力バリデーション:
  - メールアドレス: NFKC 正規化+トリム+小文字化した上で、形式チェック（例: `xxx@yyy.zzz`）と最大長（320 文字）を満たす。
  - ニックネーム: 空白のみ不可、最大 64 文字。
  - パスワード: 8〜128 文字。
  - 確認用パスワード: パスワードと一致。
- 登録成功時:
  - サーバーから返る `message` を成功通知として表示する。
  - `requires_admin_approval=true` かつ `approval_request_mailto_url` がある場合、メールクライアントを起動して管理者へ承認依頼を送れる導線を提示する（自動起動してもよい）。

### 5.2 API 要件（バックエンド）

- エンドポイント: `POST /auth/register`
- リクエスト（JSON）:
  - `email`: Email 形式の文字列（入力前処理として NFKC 正規化+トリム）
  - `password`: 8〜128 文字
  - `nickname`: 必須、空白のみ不可、最大 64 文字
- レスポンス（201）:
  - `message`: 利用者向けメッセージ
  - `requires_admin_approval`: 管理者承認が必要かどうか
  - `approval_request_mailto_url`: 管理者承認依頼用の `mailto:` URL（必要時のみ）

### 5.3 登録時のルール

1. **メールアドレスの正規化と重複判定**
   - DB には正規化済みのメールアドレス（NFKC+casefold）を保存する。
   - 大文字小文字や入力揺れ（legacy lower）を考慮して重複判定する。
2. **初回ユーザーのブートストラップ**
   - システムで最初に登録されたユーザーは `is_admin=true` かつ `is_active=true` とし、直ちにログイン可能とする。
3. **2 人目以降の承認制**
   - 2 人目以降の登録ユーザーは `is_admin=false` かつ `is_active=false` とし、管理者による有効化までログイン不可とする。
   - `requires_admin_approval=true` を返し、可能であれば `approval_request_mailto_url` を返す。
4. **ユーザー初期プロビジョニング**
   - 登録成功時に、ユーザー向けの初期データを作成する（例: 既定ステータス、既定ワークスペーステンプレート、個人用プライベートチャンネル等）。

### 5.4 代表的なエラー

| 事象 | 期待挙動 |
| --- | --- |
| 同一メールアドレスが既に存在 | 400 を返す（メッセージは「既に存在」旨）。 |
| 入力バリデーション不正（形式、長さ、必須欠落） | 422 を返す。 |
| 管理者が不在で承認依頼先が作れない | `requires_admin_approval=true` でも `approval_request_mailto_url=null` となり得るため、UI は代替の案内（管理者に連絡、等）を用意する。 |

## 6. ログイン・セッション管理 要件

### 6.1 ログイン

- エンドポイント: `POST /auth/login`
- リクエスト（JSON）: `email`, `password`
- 正常レスポンス（200）:
  - `access_token`: Bearer トークン
  - `token_type`: `bearer`
  - `user`: ユーザープロフィール（`is_admin` を含む）
- 異常系:
  - 認証失敗（メール/パスワード不一致）: 401
  - ユーザー無効: 403

### 6.2 セッション復元（SPA）

- ブラウザはトークンを `localStorage` に保存し、アプリ起動時に `/auth/me` を呼び出してユーザー情報を復元する。
- 復元に失敗した場合（401 等）は保存済みトークンを破棄し、未認証状態に戻す。

### 6.3 トークンポリシー

1. トークンは DB に平文保存せず、ハッシュ値を保存する。
2. トークンには有効期限を持たせ、期限切れは 401 とする。
3. ログイン成功時に既存トークンを破棄し、新規トークンを発行する（トークンのローテーション/単一セッション）。
4. 無効ユーザーのトークンは API 利用時に拒否する（復元含む）。

## 7. 管理者によるユーザー管理 要件

### 7.1 ユーザー一覧

- エンドポイント: `GET /admin/users`
- 前提: 管理者のみアクセス可能。
- 表示項目の例:
  - メールアドレス
  - 管理者フラグ（is_admin）
  - 有効/無効（is_active）
  - 作成日時/更新日時
- 日次上限（カード作成/コンピテンシー判定リクエスト）の個別設定値と実効値

### 7.2 ユーザー更新（権限/状態/クォータ）

- エンドポイント: `PATCH /admin/users/{user_id}`
- 更新可能項目:
  - `is_admin`（管理者/一般）
  - `is_active`（有効/無効）
- `card_daily_limit` / `evaluation_daily_limit`（クォータ個別設定: カード作成/判定リクエスト）
- 期待挙動:
  - `is_active=true` にすると当該ユーザーはログイン可能になる。
  - `is_active=false` にすると当該ユーザーはログイン不可になり、既存トークンも以降の API 利用で拒否される。

### 7.3 ユーザー削除

- エンドポイント: `DELETE /admin/users/{user_id}`
- 前提: 管理者のみアクセス可能。
- 制約:
  - 自分自身は削除できない（400）。
  - 削除時、参照整合性のため関連データの取り扱い（カスケード削除/参照の null 化）を定義する。

## 8. 非機能要件（セキュリティ中心）

- パスワードは強度要件（長さ）を満たし、サーバー側で安全なハッシュ（salt 付き PBKDF2 等）として保存する。
- 認証トークンは DB にハッシュ保存し、漏えい耐性を高める。
- 管理 API はクライアント実装に依存せず、サーバー側で管理者チェックを必須とする。
- ログ/例外メッセージに、パスワードやトークンなどの機密情報を含めない。

## 9. 受け入れ基準（Acceptance Criteria）

1. 初回登録ユーザーは管理者かつ有効として作成され、直ちにログインできる。
2. 2 人目以降の登録ユーザーは無効として作成され、管理者が有効化するまでログインできない（ログインは 403）。
3. 無効ユーザーのセッショントークンは `/auth/me` を含む認証必須 API で拒否される。
4. 管理者はユーザー一覧取得、ユーザー有効化、管理者付与/剥奪、削除を実施できる。
5. 一般ユーザーは管理 API にアクセスできない（403）。
6. 認証トークンは DB に平文保存されない。
