# 免疫マップ（AI 推測 + Mermaid 可視化）要件定義

## Document Control

| Item | Detail |
| --- | --- |
| Version | 0.1 |
| Author | Product / Engineering |
| Last Updated | 2025-12-29 |
| Status | Draft |

## 1. 背景

- 既存の「なぜなぜ分析（Why-Why）」は廃止し、免疫マップ構造へ置換する。
- AI がユーザーの現状（行動・葛藤）と深層心理（前提・バイアス・ニーズ）を推測し、Mermaid Live Editor でそのまま可視化できるフローチャートとして出力する。

## 2. 目的

- 回想（レトロスペクティブ）として、出来事や課題を「免疫マップ」の観点で整理できるようにする。
- 出力は **Mermaid 形式の単一ドキュメント**（ユーザーがそのままコピーして Mermaid Live Editor に貼り付けられるテキスト）とする。
- **内容がない要素（ノード）や線（エッジ）は出力しない**（＝図に表示されない）ことを必須要件とする。

## 3. 免疫マップの構造（固定）

### 3.1 階層定義（A〜F）

- 階層 1
  - **A**: やるべきこと / やれないこと / やりたいこと
- 階層 2
  - **B**: 阻害要因（A から線を引く）
  - **C**: 裏の目標・理想像・ゴール（A から線を引く）
- 階層 3
  - **D**: 阻害要因（B）の原因となる深層心理・バイアス（B から線を引く）
  - **E**: 真のニーズ（B と C から線を引く）
  - **F**: 根源的固定概念（C から線を引く）

### 3.2 許可する接続（エッジ）

- A → B
- A → C
- B → D
- B → E
- C → E
- C → F

## 4. ユースケース

- ユーザーが「いま抱えている課題」や「継続して起きる問題」を材料に、免疫マップを生成し、現状と深層要因を可視化する。
- 生成した Mermaid を Mermaid Live Editor に貼り付けて図として共有・議論できる。

## 5. 機能要件

### 5.1 入力

- ユーザーは、少なくとも 1 件以上の A（やるべき/やれない/やりたい）を入力できる。
- 任意で、背景・状況説明（フリーテキスト）を入力できる。
- 対象（スナップショット/カード等）に紐づけて保存できる（紐づけは任意）。

### 5.2 生成

- AI は入力（A と任意の背景）をもとに、B〜F を推測して免疫マップを作る。
- 生成結果は、次の形式で返す。
  - **Mermaid テキスト**（Mermaid Live Editor へ貼り付け可能）
  - **構造化データ**（A〜F の要素と、要素間の参照関係）
  - 任意で、短いサマリ（ユーザー向けの読み解きガイド）

### 5.3 表示・操作

- Mermaid テキストをコピーできる（コピー操作は 1 クリック）。
- Mermaid Live Editor を開く導線を提供する（貼り付けはユーザー操作）。
- 再生成（同じ入力で再推測）できる。保存する場合はバージョンを持つ。

### 5.4 非表示ルール（必須）

- 次に該当するものは **出力しない**。
  - 空文字/空白のみの要素（ノード）
  - 表示されない要素を参照する線（エッジ）
  - 要素が 0 件の階層カテゴリ（A〜F の箱/グループを出力しない）

### 5.5 権限・データ分離

- 生成・閲覧は認証済みユーザーに限定する。
- 保存する場合は、作成者（ユーザー）ごとの分離を保証する（他ユーザーは参照不可）。
- 既存の Analytics 管理者専用画面に統合する場合でも、作成者分離は維持する。

## 6. 非機能要件

- **信頼性**: AI 応答がスキーマ違反の場合は保存せず、ユーザーへ再実行可能なエラーとして返す。
- **セキュリティ**: プロンプト/ログに機微情報を不用意に残さない。保存する入力は最小限とする。
- **可用性**: AI 設定（API キー等）が無い場合は 503 とし、UI は明確に案内する。

## 7. 受け入れ基準

- A のみ入力し、B〜F が部分的に空でも、出力された Mermaid が Mermaid Live Editor で描画できる。
- 空の要素/線/カテゴリが図に現れない。
- 出力が 1 つの Mermaid ドキュメントとしてコピー可能である。

