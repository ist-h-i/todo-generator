# 免疫マップ（AI 自動抽出 + カード選択 + Mermaid 可視化）要件定義

## Document Control

| Item | Detail |
| --- | --- |
| Version | 0.2 |
| Author | Product / Engineering |
| Last Updated | 2025-12-30 |
| Status | Draft |

## 1. 背景

- 既存の「なぜなぜ分析（Why-Why）」は廃止し、免疫マップ構造へ置換する。
- AI がユーザーの現状（行動・葛藤）と深層心理（前提・バイアス・ニーズ）を推測し、Mermaid Live Editor でそのまま可視化できるフローチャートとして出力する。
- 免疫マップの起点（A）について、ユーザーの手入力を前提とせず、これまでの日報週報やタスクカードの消化状況などから AI が候補を生成し、カード選択で開始できる状態を目指す。

## 2. 目的

- 回想（レトロスペクティブ）として、出来事や課題を「免疫マップ」の観点で整理できるようにする。
- 出力は **Mermaid 形式の単一ドキュメント**（ユーザーがそのままコピーして Mermaid Live Editor に貼り付けられるテキスト）とする。
- **内容がない要素（ノード）や線（エッジ）は出力しない**（＝図に表示されない）ことを必須要件とする。
- 可能な限りユーザー関連情報からコンテキストを補完し、**ワンクリック（候補が事前選択された状態で生成ボタン押下）で「深層心理の仮説」と「状況障壁」を言語化・可視化**できる状態をゴールとする。

## 3. 免疫マップの構造（固定）

### 3.1 階層定義（A～F）

- 階層 1
  - **A**: やるべきこと / やれないこと / やりたいこと（免疫マップの起点）
- 階層 2
  - **B**: 阻害要因（A から線を引く）
  - **C**: 裏の目標・理想像・ゴール（A から線を引く）
- 階層 3
  - **D**: 阻害要因（B）の原因となる深層心理・バイアス（B から線を引く）
  - **E**: 真のニーズ（B と C から線を引く）
  - **F**: 根源的固定概念（C から線を引く）

### 3.2 許可する接続（エッジ）

- A → B
- A → C
- B → D
- B → E
- C → E
- C → F

## 4. ユースケース

- ユーザーが過去の日報週報/タスクカード履歴を材料に、免疫マップを生成し、現状と深層要因を可視化する。
- 免疫マップ生成の起点（A）は、AI が複数候補として提示し、ユーザーがカード選択で開始する（必要なら手入力で補完）。
- 生成した Mermaid を Mermaid Live Editor に貼り付けて図として共有・議論できる。

## 5. 機能要件

### 5.1 参照データ（ユーザー関連情報）

AI が候補生成および免疫マップ生成に利用できるデータは、原則として以下の **本人データのみ**とする。

- 日報週報（例: Status reports）
  - 直近 N 週間/件（例: 4 週間 or 10 件）を既定対象とし、期間/件数は UI から変更できる。
- タスクカード（例: Cards）
  - 直近 N 日の作成/完了、WIP、期限超過、ラベル分布、ストーリーポイント/見積もり、完了時刻などの集計。
  - 必要に応じて、カードのタイトル/説明の一部を参照する（送信する情報は最小化）。
- ユーザープロフィール（例: nickname/roles/bio/experience_years）
  - 推測ではなく、ユーザーが入力した内容のみを使用する。
- （任意）Analytics スナップショット（管理者作成のメトリクス/ナラティブ）
  - 免疫マップ生成の追加コンテキストとして利用できる。

### 5.2 A 候補カード生成（入力の置換）

- システムは、参照データをもとに **A 候補（カード）を複数件**（例: 6～12 件）生成して提示できる。
- 各候補カードは、少なくとも次の情報を持つ。
  - `kind`（should/cannot/want）
  - `text`（A の文言。ユーザーが Mermaid 上で理解できる短さ）
  - `rationale`（なぜこの候補になったかの説明。断定ではなく仮説）
  - `evidence`（根拠となる日報週報/カードなどの参照。引用は最小限の抜粋に留める）
  - `confidence`（任意: 0～100。低い場合は「確認したい質問」を添える）
- 候補カードは、**過度に医療/診断的な表現を避け**、本人の内省と改善に資する言い回しとする。

### 5.3 選択・編集

- UI は候補カードを一覧表示し、選択状態が分かる UI を提供する（既定で 1 件を事前選択しておく）。
- ユーザーは候補カードを 1 件以上選択できる（推奨: 1 件、上限は UI/設計で定める）。
- （任意/上級）ユーザーは、候補の文言を編集、または手入力で A を追加できる。

### 5.4 免疫マップ生成

- 免疫マップ生成は、選択された A と自動補完コンテキストを入力として B～F を推測し、免疫マップを作る。
- 生成結果は、次の形式で返す。
  - **Mermaid テキスト**（Mermaid Live Editor へ貼り付け可能）
  - **構造化データ**（A～F の要素と、要素間の参照関係）
  - **読み解きカード**（任意）: 深層心理の仮説、状況障壁、観察事実（データ由来）と推測（AI 仮説）の区別、次の一歩（小さな実験）など
  - `model` / `token_usage`（可能なら）などの生成メタデータ

### 5.5 表示・操作

- 「生成」ボタンは、選択済み候補がある場合にワンクリックで実行できる。
- Mermaid テキストをコピーできる（コピー操作は 1 クリック）。
- Mermaid Live Editor を開く導線を提供する（貼り付けはユーザー操作）。
- 再生成（同じ入力で再推測）できる。保存する場合はバージョンを持つ。

### 5.6 非表示ルール（必須）

- 次に該当するものは **出力しない**。
  - 空文字/空白のみの要素（ノード）
  - 表示されない要素を参照する線（エッジ）
  - 要素が 0 件の階層カテゴリ（A～F の箱/グループを出力しない）

### 5.7 権限・データ分離

- 生成・閲覧は認証済みユーザーに限定する。
- 保存する場合は、作成者（ユーザー）ごとの分離を保証する（他ユーザーは参照不可）。
- 既存の Analytics 管理者専用画面に統合する場合でも、作成者分離は維持する。
- 参照データ（レポート/カード等）を AI に送信する際は、最小化・マスキング・期間制限などのガードレールを設ける。

## 6. 非機能要件

- **信頼性**: AI 応答がスキーマ違反の場合は保存せず、ユーザーへ再実行可能なエラーとして返す。
- **セキュリティ**: プロンプト/ログに機微情報を不用意に残さない。保存する入力は最小限とする。
- **可用性**: AI 設定（API キー等）が無い場合は 503 とし、UI は明確に案内する。
- **コスト/性能**: 参照データ量に上限を設け、必要なら段階的サマリ（要約→候補生成→免疫マップ生成）でトークン消費を制御する。
- **説明可能性**: 観察（データ由来）と推測（AI 仮説）を区別し、根拠（evidence）を提示できること。

## 7. 受け入れ基準

- ユーザーが A を手入力しなくても、候補カード選択から免疫マップ生成まで完了できる。
- A のみ（候補選択/手入力）で、B～F が部分的に空でも、出力された Mermaid が Mermaid Live Editor で描画できる。
- 空の要素/線/カテゴリが図に現れない。
- 出力が 1 つの Mermaid ドキュメントとしてコピー可能である。
- 参照データが十分に無い場合でも、ユーザーに明確に案内し、（任意）手入力で継続できる。

